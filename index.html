<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AEA Training Terminal</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap');

    :root {
      --bg-navy: #0b0f2b;
      --bg-midnight: #0a0e1a;
      --neon-cyan: #33f6ff;
      --magenta: #ff68d7;
      --lime: #a8ff60;
      --amber: #ffc857;
      --text-light: #eaf2ff;
      --text-muted: #9fb1d6;
      --panel: #0f1620;
      --border-glow: rgba(51, 246, 255, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: var(--bg-navy);
      color: var(--text-light);
      font-family: 'Inter', system-ui, sans-serif;
      overflow-x: hidden;
    }

    /* CRT Scanline Effect */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 0, 0, 0.1) 0px,
        transparent 1px,
        transparent 2px,
        rgba(0, 0, 0, 0.1) 3px
      );
      z-index: 9999;
      animation: scanline-flicker 8s linear infinite;
    }

    @keyframes scanline-flicker {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.08; }
    }

    .screen-container {
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    .header {
      text-align: center;
      padding: 30px 20px 10px;
    }

    .header h1 {
      font-family: 'Press Start 2P', monospace;
      font-size: clamp(16px, 3vw, 24px);
      color: var(--neon-cyan);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      animation: title-glow 2s ease-in-out infinite;
    }

    @keyframes title-glow {
      0%, 100% {
        text-shadow: 0 0 10px var(--neon-cyan), 0 0 20px rgba(51, 246, 255, 0.6);
      }
      50% {
        text-shadow: 0 0 15px var(--neon-cyan), 0 0 30px rgba(51, 246, 255, 0.8);
      }
    }

    .user-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-top: 8px;
    }

    .user-bar .welcome {
      color: var(--lime);
      font-weight: 700;
    }

    .user-bar .stat {
      color: var(--amber);
    }

    .reset-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: var(--text-muted);
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
      letter-spacing: 0.05em;
      transition: all 200ms ease;
    }

    .reset-btn:hover {
      border-color: var(--magenta);
      color: var(--magenta);
      box-shadow: 0 0 12px rgba(255,104,215,0.3);
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 8px;
    }

    .divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--neon-cyan) 20%, var(--magenta) 80%, transparent);
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 0 10px var(--neon-cyan);
    }

    /* Content */
    .content-wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Dashboard */
    #dashboard {
      margin-bottom: 30px;
    }

    .dash-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 16px 0;
    }

    .card {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: inset 0 0 0 1px rgba(51,246,255,.06);
    }

    .card h3 {
      margin: 0 0 10px;
      font-family: 'Press Start 2P', monospace;
      color: var(--neon-cyan);
      font-size: 13px;
    }

    .xp-bar {
      width: 100%;
      height: 12px;
      background: linear-gradient(90deg,#0a0e1a,#121a24);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .xp-bar > div {
      height: 100%;
      background: linear-gradient(90deg, var(--neon-cyan), var(--lime));
      transition: width 600ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .badge {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,104,215,.12);
      color: var(--magenta);
      text-shadow: 0 0 6px rgba(255,104,215,.5);
      font-size: 11px;
      animation: badge-float 3s ease-in-out infinite;
    }

    @keyframes badge-float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
    }

    /* NotebookLM Card */
    .notebooklm-card {
      background: linear-gradient(145deg, #2a2010, #1f1808);
      border: 1px solid var(--amber);
      box-shadow: 0 0 15px rgba(255, 200, 87, 0.2);
    }

    .notebooklm-card h3 {
      color: var(--amber);
    }

    .notebooklm-launch {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: linear-gradient(145deg, #2a2010, #1f1808);
      border: 1px solid var(--amber);
      color: var(--text-light);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      text-decoration: none;
      transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 8px;
    }

    .notebooklm-launch:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 20px var(--amber);
    }

    /* Module Card */
    .module-card {
      background: linear-gradient(145deg, #121832, #0d1124);
      border: 2px solid var(--border-glow);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 20px rgba(51, 246, 255, 0.2);
    }

    .module-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--neon-cyan), var(--magenta), var(--lime));
      animation: border-sweep 3s linear infinite;
    }

    @keyframes border-sweep {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .module-title {
      font-family: 'Press Start 2P', monospace;
      font-size: clamp(14px, 2.5vw, 20px);
      color: var(--lime);
      margin-bottom: 15px;
      text-transform: uppercase;
    }

    .module-desc {
      color: var(--text-muted);
      line-height: 1.6;
      font-size: 14px;
      margin-bottom: 25px;
    }

    /* Tab Grid */
    .tab-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .tab-button {
      background: linear-gradient(145deg, #1a2347, #12183a);
      border: 2px solid var(--neon-cyan);
      color: var(--text-light);
      padding: 18px 16px;
      border-radius: 12px;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .tab-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5), 0 0 25px var(--neon-cyan);
    }

    .tab-button[data-accent="cyan"] { border-color: var(--neon-cyan); }
    .tab-button[data-accent="magenta"] { border-color: var(--magenta); }
    .tab-button[data-accent="lime"] { border-color: var(--lime); }
    .tab-button[data-accent="amber"] { border-color: var(--amber); }

    .tab-icon {
      display: block;
      font-size: 28px;
      margin-bottom: 8px;
    }

    /* Tab Views */
    .tab-view {
      display: none;
    }

    .tab-view.active {
      display: block;
      animation: fade-in 250ms ease;
    }

    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .back-button {
      background: linear-gradient(145deg, #1a2347, #12183a);
      border: 2px solid var(--magenta);
      color: var(--text-light);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 200ms ease;
    }

    .back-button:hover {
      transform: translateX(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5), 0 0 25px var(--magenta);
    }

    /* Viewer Container */
    .viewer-container {
      background: linear-gradient(145deg, #121832, #0d1124);
      border: 2px solid var(--border-glow);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(51, 246, 255, 0.3);
    }

    .viewer-header {
      background: linear-gradient(145deg, #1a2347, #12183a);
      padding: 16px 20px;
      border-bottom: 2px solid var(--border-glow);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .viewer-header h2 {
      font-family: 'Press Start 2P', monospace;
      font-size: clamp(11px, 2vw, 14px);
      color: var(--neon-cyan);
      text-transform: uppercase;
      flex: 1;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--lime);
      box-shadow: 0 0 10px var(--lime);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .viewer-body {
      background: var(--bg-midnight);
      padding: 4px;
      min-height: 500px;
    }

    .viewer-iframe {
      width: 100%;
      height: 600px;
      border: 0;
      display: block;
      background: #000;
    }

    .viewer-footer {
      background: linear-gradient(145deg, #12183a, #0d1124);
      padding: 12px 20px;
      border-top: 2px solid var(--border-glow);
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Login Modal */
    .login-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: modal-fade-in 400ms ease;
    }

    @keyframes modal-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .login-box {
      background: linear-gradient(145deg, #121832, #0d1124);
      border: 2px solid var(--neon-cyan);
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 40px rgba(51, 246, 255, 0.4);
      animation: modal-slide-in 400ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modal-slide-in {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .login-box h2 {
      font-family: 'Press Start 2P', monospace;
      font-size: clamp(16px, 4vw, 22px);
      color: var(--neon-cyan);
      margin: 0 0 20px;
      text-align: center;
      text-shadow: 0 0 15px var(--neon-cyan);
    }

    .login-box p {
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .login-input {
      width: 100%;
      background: var(--bg-midnight);
      border: 2px solid rgba(51, 246, 255, 0.3);
      color: var(--text-light);
      padding: 14px 16px;
      border-radius: 10px;
      font-size: 16px;
      margin-bottom: 24px;
      transition: all 200ms ease;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--neon-cyan);
      box-shadow: 0 0 20px rgba(51, 246, 255, 0.3);
    }

    .login-submit {
      width: 100%;
      background: linear-gradient(145deg, #1a2347, #12183a);
      border: 2px solid var(--lime);
      color: var(--lime);
      padding: 16px 20px;
      border-radius: 10px;
      font-family: 'Press Start 2P', monospace;
      font-size: 14px;
      font-weight: 400;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
      text-shadow: 0 0 10px var(--lime);
    }

    .login-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px var(--lime);
      background: linear-gradient(145deg, #2a3357, #1a2347);
    }
    
    .login-submit:active {
      transform: translateY(0);
    }

    /* Celebrations */
    .badge-unlock {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #121832, #0d1124);
      border: 3px solid var(--magenta);
      border-radius: 20px;
      padding: 40px;
      z-index: 10001;
      box-shadow: 0 0 60px rgba(255, 104, 215, 0.6);
      animation: badge-popup 600ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
      text-align: center;
      min-width: 300px;
    }

    @keyframes badge-popup {
      0% { transform: translate(-50%, -50%) scale(0.5) rotate(-10deg); opacity: 0; }
      60% { transform: translate(-50%, -50%) scale(1.1) rotate(5deg); }
      100% { transform: translate(-50%, -50%) scale(1) rotate(0); opacity: 1; }
    }

    .badge-unlock-icon {
      font-size: 64px;
      margin-bottom: 16px;
      display: block;
      animation: icon-bounce 1s ease infinite;
    }

    @keyframes icon-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .badge-unlock h3 {
      font-family: 'Press Start 2P', monospace;
      color: var(--magenta);
      font-size: 18px;
      margin: 0 0 12px;
      text-shadow: 0 0 15px var(--magenta);
    }

    .badge-unlock p {
      color: var(--text-light);
      font-size: 14px;
      margin: 0 0 20px;
    }

    .badge-unlock-close {
      background: linear-gradient(145deg, #1a2347, #12183a);
      border: 2px solid var(--magenta);
      color: var(--text-light);
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      font-size: 13px;
      transition: all 200ms ease;
    }

    .badge-unlock-close:hover {
      box-shadow: 0 0 20px var(--magenta);
      transform: scale(1.05);
    }

    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Press Start 2P', monospace;
      font-size: 32px;
      color: var(--lime);
      text-shadow: 0 0 20px var(--lime);
      z-index: 9999;
      pointer-events: none;
      animation: xp-float 1s ease-out forwards;
    }

    @keyframes xp-float {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
      50% { opacity: 1; transform: translate(-50%, -60%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
    }

    .level-flash {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(51, 246, 255, 0.4) 0%, transparent 70%);
      z-index: 9998;
      pointer-events: none;
      animation: screen-flash 800ms ease-out;
    }

    @keyframes screen-flash {
      0% { opacity: 0; }
      50% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Hide/Show */
    .home-view { display: block; }
    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 920px) {
      .dash-grid { grid-template-columns: 1fr; }
    }
    
    @media (max-width: 640px) {
      .tab-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 14px; }
      .module-card { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="screen-container">
    <header class="header">
      <h1>AEA Training Terminal</h1>
      <div class="user-bar" id="user-bar" style="display:none;">
        <span class="welcome">Welcome back, <span id="user-name-display"></span>!</span>
        <span class="stat">Level <span id="level-display">1</span></span>
        <span class="stat"><span id="xp-display">0</span> XP</span>
        <button class="reset-btn" id="reset-btn" title="Reset Progress">‚öôÔ∏è Reset</button>
      </div>
      <p class="subtitle">Flight Instruments & Pitot Static Systems</p>
      <div class="divider"></div>
    </header>

    <main class="content-wrapper">
      <!-- Dashboard -->
      <section id="dashboard">
        <div class="dash-grid">
          <div class="card">
            <h3>Level <span id="level-num">1</span></h3>
            <div class="xp-bar">
              <div id="xp-progress" style="width:0%"></div>
            </div>
            <p style="margin:0;font-size:12px;color:var(--text-muted);">
              <span id="xp-current">0</span> / <span id="xp-needed">50</span> XP
            </p>
          </div>
          
          <div class="card notebooklm-card">
            <h3>ü§ñ AI Assistant</h3>
            <p style="margin:0 0 8px;font-size:12px;color:var(--text-muted);">
              Organize & analyze your training notes
            </p>
            <a href="https://notebooklm.google.com" target="_blank" rel="noopener" class="notebooklm-launch">
              üìù Launch NotebookLM ‚Üó
            </a>
          </div>
          
          <div class="card">
            <h3>Badges</h3>
            <div class="badges" id="badges-container">
              <em style="font-size:12px;color:var(--text-muted);">No badges yet</em>
            </div>
          </div>
        </div>
      </section>

      <!-- Home View -->
      <div id="home-view" class="home-view">
        <div class="module-card">
          <h2 class="module-title">Training Modules</h2>
          <p class="module-desc">
            Master the critical systems that provide essential flight data to pilots. 
            Learn to troubleshoot pitot-static instruments, understand pressure sensing systems, 
            and diagnose common faults in altimeters, airspeed indicators, and VSI.
          </p>

          <div class="tab-grid">
            <button class="tab-button" data-tab="classroom" data-accent="cyan" onclick="showTab('classroom')">
              <span class="tab-icon">üìö</span>
              Classroom
            </button>

            <button class="tab-button" data-tab="flashcards" data-accent="magenta" onclick="showTab('flashcards')">
              <span class="tab-icon">üé¥</span>
              Flashcards
            </button>

            <button class="tab-button" data-tab="practice" data-accent="lime" onclick="showTab('practice')">
              <span class="tab-icon">‚úçÔ∏è</span>
              Practice Test
            </button>

            <button class="tab-button" data-tab="jeopardy" data-accent="amber" onclick="showTab('jeopardy')">
              <span class="tab-icon">üéØ</span>
              Jeopardy
            </button>
          </div>
        </div>
      </div>

      <!-- Classroom Tab -->
      <div id="classroom-view" class="tab-view">
        <button class="back-button" onclick="showTab('home')">‚óÑ Back</button>
        <div class="viewer-container">
          <div class="viewer-header">
            <div class="status-indicator"></div>
            <h2>Classroom - Interactive Lessons</h2>
          </div>
          <div class="viewer-body">
	<iframe class="viewer-iframe" id="classroom-iframe" src="https://storage.googleapis.com/caet-prep/Principles%20of%20Electricity/fundamentals-of-direct-current-raw-6mYaejXk/content/index.html"></iframe>
            "></iframe>
          </div>
          <div class="viewer-footer">System Status: Online // Module: Classroom</div>
        </div>
      </div>

      <!-- Flashcards Tab -->
      <div id="flashcards-view" class="tab-view">
        <button class="back-button" onclick="showTab('home')">‚óÑ Back</button>
        <div class="viewer-container">
          <div class="viewer-header">
            <div class="status-indicator"></div>
            <h2>Flashcards - Study Mode</h2>
          </div>
          <div class="viewer-body">
<iframe class="viewer-iframe" id="flashcards-iframe" src="CAET Practice Test -- MASTER.html"></iframe>
            "></iframe>
          </div>
          <div class="viewer-footer">System Status: Online // Module: Flashcards</div>
        </div>
      </div>

      <!-- Practice Test Tab -->
      <div id="practice-view" class="tab-view">
        <button class="back-button" onclick="showTab('home')">‚óÑ Back</button>
        <div class="viewer-container">
          <div class="viewer-header">
            <div class="status-indicator"></div>
            <h2>Practice Test - Assessment</h2>
          </div>
          <div class="viewer-body">
          <iframe class="viewer-iframe" id="practice-iframe" src="CAET Practice Test -- MASTER.html"></iframe>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1"><title>Jeopardy ‚Äî Player vs AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #111827;
    --panel: #1f2937;
    --board: #111827;
    --tile: #4f46e5;
    --tile-hover: #6366f1;
    --tile-text: #f59e0b;
    --ink: #e5e7eb;
    --ink-dim: #9ca3af;
    --border: #374151;
    --ok: #22c55e;
    --warn: #f59e0b;
    --err: #ef4444;
    --player: #3b82f6;
    --ai: #f43f5e;
    --font-heading: 'Montserrat', sans-serif;
    --font-body: 'Roboto', sans-serif;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: var(--font-body);
    background: var(--bg);
    color: var(--ink);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .top{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
  .badge{padding:6px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--border);color:var(--ink-dim); font-size: 0.9rem; font-weight: 700;}

  /* Scores Section */
  .scores{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
  .player-box{
    background:var(--panel);
    border:2px solid var(--player);
    border-radius:12px;
    padding:16px;
    text-align:center;
  }
  .player-box.active{
    box-shadow: 0 0 20px var(--player);
    animation: pulse 1.5s ease-in-out infinite;
  }
  .ai-box{
    background:var(--panel);
    border:2px solid var(--ai);
    border-radius:12px;
    padding:16px;
    text-align:center;
  }
  .ai-box.active{
    box-shadow: 0 0 20px var(--ai);
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
  .player-name{font-size:0.9rem;color:var(--ink-dim);margin-bottom:4px}
  .player-score{font-size:2rem;font-weight:900;color:var(--player);font-family:var(--font-heading)}
  .ai-score{font-size:2rem;font-weight:900;color:var(--ai);font-family:var(--font-heading)}
  .turn-indicator{margin-top:8px;font-size:0.85rem;font-weight:700;color:var(--tile-text)}

  .board{
    background: var(--panel);
    border-radius: 16px;
    border: 1px solid var(--border);
    padding: 16px;
    display: grid;
    gap: 12px;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3), 0 8px 10px -6px rgba(0,0,0,0.3);
  }
  .row{display:grid;gap:12px}
  .row-3{grid-template-columns:repeat(3,1fr)}
  .tile{
    display: grid;
    place-items: center;
    padding: 18px;
    border-radius: 12px;
    background: var(--tile);
    border: none;
    color: var(--tile-text);
    font-family: var(--font-heading);
    font-weight: 900;
    font-size: 1.6rem;
    cursor: pointer;
    min-height: 80px;
    text-align: center;
    user-select: none;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    transition: transform 0.15s ease, background-color 0.15s ease, box-shadow 0.15s ease;
    position: relative;
  }
  .tile:not(.used):hover{
    transform: scale(1.05);
    background: var(--tile-hover);
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
  }
  .tile.used{
    background: rgba(31, 41, 55, 0.5);
    color: #6b7280;
    cursor: not-allowed;
    text-shadow: none;
  }
  .tile.ai-thinking{
    animation: ai-glow 0.5s ease-in-out infinite alternate;
  }
  @keyframes ai-glow{
    from{box-shadow: 0 0 10px var(--ai)}
    to{box-shadow: 0 0 25px var(--ai)}
  }
  .cats{gap:12px;margin-bottom:8px}
  .cat{
    display: grid;
    place-items: center;
    padding: 10px;
    border-radius: 10px;
    background: var(--bg);
    color: var(--ink);
    border: 1px solid var(--border);
    font-family: var(--font-heading);
    font-weight: 700;
    min-height: 50px;
    text-align: center;
    font-size: 0.9rem;
  }

  .round-indicator{
    padding: 8px 16px;
    border-radius: 999px;
    background: var(--tile);
    border: 2px solid var(--tile-hover);
    color: white;
    font-weight: 900;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
  }

  /* Buzzer Section */
  .buzzer-section{
    display:grid;
    gap:12px;
    margin-top:16px;
    grid-template-columns: 1fr 1fr;
  }
  .buzz-btn{
    padding: 20px;
    border-radius: 12px;
    font-size: 1.3rem;
    font-weight: 900;
    font-family: var(--font-heading);
    cursor: pointer;
    border: 3px solid;
    transition: all 0.15s ease;
    text-transform: uppercase;
  }
  .player-buzz{
    background: var(--player);
    border-color: var(--player);
    color: white;
  }
  .player-buzz:hover:not(:disabled){
    transform: scale(1.05);
    box-shadow: 0 0 30px var(--player);
  }
  .player-buzz:disabled{
    opacity: 0.3;
    cursor: not-allowed;
  }
  .player-buzz.winner{
    animation: buzz-winner 0.5s ease;
    box-shadow: 0 0 40px var(--player);
  }
  .ai-buzz{
    background: var(--ai);
    border-color: var(--ai);
    color: white;
    cursor: default;
  }
  .ai-buzz.winner{
    animation: buzz-winner 0.5s ease;
    box-shadow: 0 0 40px var(--ai);
  }
  @keyframes buzz-winner{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.1)}
  }

  .qhead{display:flex;align-items:center;justify-content:space-between;gap:10px; flex-wrap: wrap;}
  .qtext{font-size:1.2rem;line-height:1.6;color:#ffffff; font-weight: 500; margin: 8px 0;}
  .choices{display:grid;gap:10px;margin-top:16px}
  .choice{
    display:flex;gap:12px;align-items:center;padding:14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;
    transition: transform 0.15s ease, background-color 0.15s ease;
    text-align: left;
    font-size: 1rem;
    line-height: 1.4;
  }
  .choice:hover:not(:disabled){background:#374151; transform: translateY(-2px);}
  .choice.correct{border-color:var(--ok); background:rgba(34, 197, 94, 0.1); color: var(--ok);}
  .choice.wrong{border-color:var(--err); background:rgba(239, 68, 68, 0.1); color: var(--err);}
  .choice > strong { color: var(--tile-text); }
  .choice.correct > strong, .choice.wrong > strong { color: inherit; }

  .explanation{
    margin-top: 16px;
    padding: 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    border-radius: 10px;
    line-height: 1.6;
  }
  .explanation h4{
    margin: 0 0 8px 0;
    color: #3b82f6;
    font-size: 1.1rem;
  }
  .explanation p{
    margin: 8px 0;
    color: var(--ink);
  }
  .explanation small{
    color: var(--ink-dim);
    font-style: italic;
  }

  .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .kpi{font-variant-numeric:tabular-nums;font-weight:700; color: var(--tile-text);}
  .btn{
    padding: 10px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: #374151;
    color: var(--ink);
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.15s ease, background-color 0.15s ease;
  }
  .btn:hover{background: #4b5563; transform: translateY(-2px);}
  .btn.ghost{background:transparent;color:var(--ink-dim);border-color:var(--border)}
  .btn.ghost:hover{color: var(--ink); background: var(--panel);}
  .center{text-align:center}
  .hidden{display:none}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  
  .timer {
    display:flex;
    align-items:center;
    gap:8px;
  }
  #qTimer {
    background:var(--bg);
    border:1px solid var(--border);
    padding: 6px 12px;
    border-radius: 999px;
  }
  .bar{height:10px;background:var(--bg);border-radius:999px;overflow:hidden;width:100px;border:1px solid var(--border)}
  .bar>div{
    height:100%;
    background:linear-gradient(90deg, var(--ok), var(--warn), var(--err));
    width:100%;
    transition: width 1s linear;
  }

  .overlay{position:fixed;inset:0;pointer-events:none; z-index: 200;}
  .confetti i{position:absolute;width:8px;height:14px;opacity:.95;animation:fall 1.6s linear forwards}
  @keyframes fall{to{transform:translateY(120vh) rotate(360deg);opacity:.2}}

  .modal{
    position:fixed;
    inset:0;
    background:rgba(17, 24, 39, 0.9);
    backdrop-filter: blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:100;
    opacity: 0;
    transform: scale(0.98);
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s;
  }
  .modal.show{
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s;
  }
  .card{
    background: var(--panel);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 16px;
    max-width: 650px;
    width: 100%;
    padding: 24px;
    display: grid;
    gap: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    max-height: 90vh;
    overflow-y: auto;
  }
  .card h2{margin:0;font-family: var(--font-heading); font-size:1.6rem; color: var(--tile-text);}
  .input{display:flex;gap:8px;align-items:center}
  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--ink); font-size: 1rem;}

  #gameEndModal .card {
      padding: 0;
      overflow: hidden;
      text-align: center;
      max-width: 500px;
  }
  .endGameContent {
      padding: 24px;
      display: grid;
      gap: 12px;
  }
  .endGameContent h2 {
      font-size: 2.2rem;
      color: var(--tile-text);
      margin-bottom: 5px;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
  }
  .endGameContent .final-scores{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 16px 0;
  }
  .endGameContent .score-box{
      padding: 12px;
      border-radius: 10px;
      border: 2px solid;
  }
  .endGameContent .player-final{
      border-color: var(--player);
      background: rgba(59, 130, 246, 0.1);
  }
  .endGameContent .ai-final{
      border-color: var(--ai);
      background: rgba(244, 63, 94, 0.1);
  }
  .endGameContent p {
      color: var(--ink-dim);
      line-height: 1.5;
  }
  #finalRestartBtn {
      background: var(--tile);
      color: #fff;
      font-size: 1.1rem;
      padding: 12px 24px;
      border: none;
      box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
  }
  #finalRestartBtn:hover {
      background: var(--tile-hover);
      box-shadow: 0 6px 15px rgba(79, 70, 229, 0.5);
  }

  .round-transition{
    position:fixed;
    inset:0;
    background:rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(8px);
    display:flex;
    flex-direction: column;
    align-items:center;
    justify-content:center;
    z-index:150;
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0s 0.3s;
  }
  .round-transition.show{
    opacity: 1;
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.3s ease, visibility 0s 0s;
  }
  .round-transition h1{
    font-family: var(--font-heading);
    font-size: 3.5rem;
    color: var(--tile-text);
    margin: 0;
    text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
    animation: glow 2s ease-in-out infinite;
  }
  @keyframes glow{
    0%,100%{text-shadow: 0 0 30px rgba(245, 158, 11, 0.5)}
    50%{text-shadow: 0 0 50px rgba(245, 158, 11, 0.8)}
  }
  .round-transition p{
    font-size: 1.3rem;
    color: var(--ink);
    margin-top: 16px;
  }

  @media (max-width:780px){ 
    .row-3{grid-template-columns:1fr} 
    .tile{min-height:56px} 
    .qtext{font-size:1.05rem}
    .scores{grid-template-columns:1fr}
    .buzzer-section{grid-template-columns:1fr}
    .round-transition h1{font-size: 2.5rem}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="top">
    <div class="badge">Electrical Systems Jeopardy ‚Äî Player vs AI</div>
    <div class="meta">
      <span class="round-indicator" id="roundIndicator">ROUND 1: JEOPARDY</span>
      <span>Tiles left: <span class="kpi" id="qLeft">15</span></span>
      <button id="mute" class="btn ghost">üîà Sound</button>
      <button id="difficultyBtn" class="btn ghost">AI: Medium</button>
    </div>
  </div>

  <div class="scores">
    <div class="player-box" id="playerBox">
      <div class="player-name">YOU</div>
      <div class="player-score" id="pScore">$0</div>
      <div class="turn-indicator" id="playerTurn"></div>
    </div>
    <div class="ai-box" id="aiBox">
      <div class="player-name">AI OPPONENT</div>
      <div class="ai-score" id="aiScore">$0</div>
      <div class="turn-indicator" id="aiTurn"></div>
    </div>
  </div>

  <div class="board">
    <div class="cats row row-3" id="catRow"></div>
    <div class="row row-3" id="valRow1"></div>
    <div class="row row-3" id="valRow2"></div>
    <div class="row row-3" id="valRow3"></div>
    <div class="row row-3" id="valRow4"></div>
    <div class="row row-3" id="valRow5"></div>
  </div>
</div>

<div class="round-transition" id="roundTransition">
  <h1 id="transitionTitle">DOUBLE JEOPARDY</h1>
  <p id="transitionSubtitle">All values are doubled!</p>
</div>

<div class="modal" id="qCard">
  <div class="card">
    <div class="qhead">
      <div class="meta"><span id="qCat" class="badge"></span><span id="qValue" class="badge"></span></div>
      <div class="meta">
        <div class="timer" id="qTimer">
          <span>Time:</span>
          <div class="bar"><div id="tFill"></div></div>
          <span class="kpi" id="tLeft">10</span>s
        </div>
        <span class="badge" id="ddBadge" style="display:none;background:var(--warn);border-color:var(--warn);color:#111;">DAILY DOUBLE</span>
      </div>
    </div>
    <div class="qtext" id="qText">Question</div>
    
    <div id="buzzSection" class="buzzer-section hidden">
      <button class="buzz-btn player-buzz" id="playerBuzz" disabled>üîµ BUZZ IN!</button>
      <button class="buzz-btn ai-buzz" id="aiBuzz">üî¥ AI</button>
    </div>

    <div class="choices" id="choices"></div>
    <div id="feedback" class="center"></div>
    <div class="center" style="margin-top:10px;">
      <button id="closeQ" class="btn hidden">Continue</button>
    </div>
  </div>
</div>

<div class="modal" id="finalCard">
  <div class="card">
    <div class="qhead">
      <div class="meta"><span class="badge" id="finalCat">Final Category</span></div>
      <div class="meta"><span class="badge" style="background:#a855f7;border-color:#a855f7;color:#fff;">FINAL JEOPARDY</span></div>
    </div>
    <div class="qtext" id="finalText">Final question text‚Ä¶</div>
    <div class="choices" id="finalChoices"></div>
    <div id="finalFeedback" class="center"></div>
    <div class="center" style="margin-top:10px;">
      <button id="closeFinal" class="btn hidden">See Results</button>
    </div>
  </div>
</div>

<div class="overlay confetti" id="confetti"></div>

<div class="modal" id="ddModal">
  <div class="card">
    <h2 id="ddTitle">DAILY DOUBLE!</h2>
    <div id="ddWho"></div>
    <div id="ddScoreDisplay"></div>
    <div id="ddWagerSection"></div>
    <div class="meta" id="ddButtons"></div>
  </div>
</div>

<div class="modal" id="fjModal">
  <div class="card">
    <h2>FINAL JEOPARDY</h2>
    <div>Category: <b id="fjCat">Category</b></div>
    <div style="margin:16px 0">
      <div style="margin-bottom:8px">Your Score: <b class="kpi" style="color:var(--player)" id="fjPScore">$0</b></div>
      <div class="input"><span>Your Wager: $</span><input id="fjPWager" type="number" min="0" step="50" value="0"></div>
    </div>
    <div style="margin:16px 0">
      <div style="margin-bottom:8px">AI Score: <b class="kpi" style="color:var(--ai)" id="fjAIScore">$0</b></div>
      <div>AI Wager: <b class="kpi" style="color:var(--ai)" id="fjAIWager">$???</b> (Hidden)</div>
    </div>
    <div class="meta">
      <button id="fjStart" class="btn">Reveal Final Question</button>
    </div>
  </div>
</div>

<div class="modal" id="gameEndModal">
  <div class="card">
    <div class="endGameContent">
      <h2 id="endGameTitle">Game Over!</h2>
      <div class="final-scores">
        <div class="score-box player-final">
          <div style="font-size:0.9rem;color:var(--ink-dim)">YOU</div>
          <div class="kpi" style="color:var(--player);font-size:1.8rem" id="endPlayerScore">$0</div>
        </div>
        <div class="score-box ai-final">
          <div style="font-size:0.9rem;color:var(--ink-dim)">AI</div>
          <div class="kpi" style="color:var(--ai);font-size:1.8rem" id="endAIScore">$0</div>
        </div>
      </div>
      <p id="endGameMessage">Thanks for playing!</p>
      <button id="finalRestartBtn" class="btn">Play Again</button>
    </div>
  </div>
</div>

<script>
/* ========================================================================
   QUESTION BANK - CUSTOMIZE THIS SECTION FOR DIFFERENT JEOPARDY GAMES
   ========================================================================

   TO CREATE A NEW JEOPARDY GAME:
   1. Keep the structure exactly the same
   2. Change category names (must have exactly 6 categories + FINAL)
   3. Update questions, answers, and explanations for your topic
   4. Each category needs exactly 5 questions
   5. Round 1 categories use base values: $100, $200, $300, $400, $500
   6. Round 2 categories use doubled values: $200, $400, $600, $800, $1000

   STRUCTURE:
   - First 3 categories = Round 1 (Jeopardy)
   - Next 3 categories = Round 2 (Double Jeopardy) 
   - FINAL = Final Jeopardy question

   ======================================================================== */

const QUESTION_BANK = {
  // ==================== ROUND 1: JEOPARDY ====================

  "DC Concepts": [
    {
      id: "dc-001",
      difficulty: 1,
      pointValue: 100,
      timeLimit: 10,
      question: "This is the unit of measurement for electrical 'pressure' or potential difference.",
      answers: ["Amperes (Amps)", "Ohms (Œ©)", "Volts (V)", "Watts (W)"],
      correctIndex: 2,
      explanation: "Voltage (Volts) is the electrical pressure that causes current to flow.",
      reference: "Fundamentals of DC"
    },
    {
      id: "dc-002",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "This is the unit of measurement for the rate of electron flow in a circuit.",
      answers: ["Amperes (Amps)", "Ohms (Œ©)", "Volts (V)", "Watts (W)"],
      correctIndex: 0,
      explanation: "Current (Amperes) is the measure of how many electrons flow past a point per second.",
      reference: "Fundamentals of DC"
    },
    {
      id: "dc-003",
      difficulty: 3,
      pointValue: 300,
      timeLimit: 14,
      question: "A material, like rubber or plastic, that strongly opposes the flow of current is called:",
      answers: ["A conductor", "A semiconductor", "A resistor", "An insulator"],
      correctIndex: 3,
      explanation: "Insulators have very high resistance and are used to prevent current from flowing where it is not wanted.",
      reference: "Conductors vs. Insulators"
    },
    {
      id: "dc-004",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 15,
      question: "This is the unit of measurement for the opposition to current flow.",
      answers: ["Amperes (Amps)", "Ohms (Œ©)", "Volts (V)", "Watts (W)"],
      correctIndex: 1,
      explanation: "Resistance (Ohms) is the property that opposes the flow of current.",
      reference: "Fundamentals of DC"
    },
    {
      id: "dc-005",
      difficulty: 4,
      pointValue: 500,
      timeLimit: 18,
      question: "In 'Direct Current' (DC), the electrons flow in:",
      answers: ["Two directions, alternating", "One direction only", "A circular, spinning pattern", "High-frequency pulses"],
      correctIndex: 1,
      explanation: "Direct Current (DC) is defined by its unidirectional flow, typically from negative to positive.",
      reference: "AC vs. DC"
    }
  ],

  "Ohm's Law": [
    {
      id: "ohm-001",
      difficulty: 1,
      pointValue: 100,
      timeLimit: 10,
      question: "What is the correct formula for Ohm's Law?",
      answers: ["V = I x R", "R = V x I", "I = V x R", "P = V x I"],
      correctIndex: 0,
      explanation: "Ohm's Law states Voltage (V) equals Current (I) multiplied by Resistance (R).",
      reference: "Ohm's Law Formula"
    },
    {
      id: "ohm-002",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 15,
      question: "A 10-ohm resistor has 2 amps of current flowing through it. What is the voltage drop across it?",
      answers: ["5 Volts", "12 Volts", "0.2 Volts", "20 Volts"],
      correctIndex: 3,
      explanation: "Using V = I x R: 2 Amps * 10 Ohms = 20 Volts.",
      reference: "Ohm's Law Calculation"
    },
    {
      id: "ohm-003",
      difficulty: 3,
      pointValue: 300,
      timeLimit: 15,
      question: "A 28-volt circuit has a resistance of 7 ohms. How much current is flowing?",
      answers: ["4 Amps", "196 Amps", "21 Amps", "0.25 Amps"],
      correctIndex: 0,
      explanation: "Using I = V / R: 28 Volts / 7 Ohms = 4 Amps.",
      reference: "Ohm's Law Calculation"
    },
    {
      id: "ohm-004",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 15,
      question: "A lamp connected to a 14-volt source draws 2 amps. What is the lamp's resistance?",
      answers: ["28 Ohms", "12 Ohms", "7 Ohms", "16 Ohms"],
      correctIndex: 2,
      explanation: "Using R = V / I: 14 Volts / 2 Amps = 7 Ohms.",
      reference: "Ohm's Law Calculation"
    },
    {
      id: "ohm-005",
      difficulty: 4,
      pointValue: 500,
      timeLimit: 18,
      question: "In a circuit with constant voltage, if you double the resistance, what happens to the current?",
      answers: ["It doubles", "It stays the same", "It is cut in half", "It becomes zero"],
      correctIndex: 2,
      explanation: "Current and resistance are inversely proportional (I = V/R). If R doubles, I is halved.",
      reference: "Ohm's Law Relationships"
    }
  ],

  "The Power Law": [
    {
      id: "pwr-001",
      difficulty: 1,
      pointValue: 100,
      timeLimit: 10,
      question: "What is the basic formula for electrical power (Watt's Law)?",
      answers: ["P = I x R", "P = V / I", "P = V x I", "P = V / R"],
      correctIndex: 2,
      explanation: "Power (P) in Watts equals Voltage (V) multiplied by Current (I).",
      reference: "Power Law Formula"
    },
    {
      id: "pwr-002",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 15,
      question: "A 28V circuit is drawing 10 amps. How much power is being consumed?",
      answers: ["2.8 Watts", "280 Watts", "38 Watts", "0.35 Watts"],
      correctIndex: 1,
      explanation: "Using P = V x I: 28 Volts * 10 Amps = 280 Watts.",
      reference: "Power Law Calculation"
    },
    {
      id: "pwr-003",
      difficulty: 3,
      pointValue: 300,
      timeLimit: 15,
      question: "What is the alternate formula for power when you only know current and resistance?",
      answers: ["P = I¬≤ / R", "P = R¬≤ / I", "P = I x R¬≤", "P = I¬≤ x R"],
      correctIndex: 3,
      explanation: "Since V = IR, substitute (IR) for V in P=VI, which gives P = (IR)I, or P = I¬≤R.",
      reference: "Power Law Formula"
    },
    {
      id: "pwr-004",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 18,
      question: "A 100-ohm resistor has 2 amps flowing through it. How much power is it dissipating?",
      answers: ["200 Watts", "50 Watts", "400 Watts", "0.02 Watts"],
      correctIndex: 2,
      explanation: "Using P = I¬≤ x R: (2 Amps * 2 Amps) * 100 Ohms = 400 Watts.",
      reference: "Power Law Calculation"
    },
    {
      id: "pwr-005",
      difficulty: 4,
      pointValue: 500,
      timeLimit: 18,
      question: "What is the alternate formula for power when you only know voltage and resistance?",
      answers: ["P = V¬≤ / R", "P = R¬≤ / V", "P = V x R¬≤", "P = V¬≤ x R"],
      correctIndex: 0,
      explanation: "Since I = V/R, substitute (V/R) for I in P=VI, which gives P = V(V/R), or P = V¬≤/R.",
      reference: "Power Law Formula"
    }
  ],

  // ==================== ROUND 2: DOUBLE JEOPARDY ====================

  "Series Circuits": [
    {
      id: "ser-201",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "In a series circuit, the total resistance (Rt) is calculated by:",
      answers: ["Averaging all resistors", "Using the smallest resistor value", "Adding all individual resistances", "Rt = (R1*R2)/(R1+R2)"],
      correctIndex: 2,
      explanation: "In a series circuit, resistances add up: Rt = R1 + R2 + R3 + ...",
      reference: "Series Circuit Rules"
    },
    {
      id: "ser-202",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 14,
      question: "What is the rule for current in a series circuit?",
      answers: ["It is the same through all components", "It divides at each component", "It is highest at the last component", "It is zero at the end of the loop"],
      correctIndex: 0,
      explanation: "A series circuit has only one path, so the current (flow) must be the same everywhere.",
      reference: "Series Circuit Rules"
    },
    {
      id: "ser-203",
      difficulty: 4,
      pointValue: 600,
      timeLimit: 16,
      question: "Three resistors are in series: 10 ohms, 20 ohms, and 30 ohms. What is the total resistance?",
      answers: ["30 Ohms", "5.45 Ohms", "60 Ohms", "6000 Ohms"],
      correctIndex: 2,
      explanation: "Rt = R1 + R2 + R3. 10 + 20 + 30 = 60 Ohms.",
      reference: "Series Circuit Calculation"
    },
    {
      id: "ser-204",
      difficulty: 4,
      pointValue: 800,
      timeLimit: 18,
      question: "This law states that the sum of all voltage drops in a series loop equals the source voltage.",
      answers: ["Ohm's Law", "Kirchhoff's Current Law (KCL)", "Watt's Law", "Kirchhoff's Voltage Law (KVL)"],
      correctIndex: 3,
      explanation: "Kirchhoff's Voltage Law (KVL) describes how voltage is distributed in a closed loop.",
      reference: "Kirchhoff's Voltage Law"
    },
    {
      id: "ser-205",
      difficulty: 5,
      pointValue: 1000,
      timeLimit: 20,
      question: "If one of three bulbs connected in series burns out (fails open), what happens to the other two?",
      answers: ["They get brighter", "They get dimmer", "They both go out", "They are unaffected"],
      correctIndex: 2,
      explanation: "A burned-out bulb creates an open circuit, breaking the only path for current and stopping all flow.",
      reference: "Series Circuit Troubleshooting"
    }
  ],

  "Parallel Circuits": [
    {
      id: "par-201",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "What is the rule for voltage in a parallel circuit?",
      answers: ["It is the same across all branches", "It divides equally among all branches", "It is zero across all branches", "It is highest at the first branch"],
      correctIndex: 0,
      explanation: "Components in parallel are connected across the same two points, so they must have the same voltage.",
      reference: "Parallel Circuit Rules"
    },
    {
      id: "par-202",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 14,
      question: "This law states that the total current entering a junction must equal the total current leaving it.",
      answers: ["Ohm's Law", "Kirchhoff's Current Law (KCL)", "Watt's Law", "Kirchhoff's Voltage Law (KVL)"],
      correctIndex: 1,
      explanation: "Kirchhoff's Current Law (KCL) describes how current splits in parallel branches.",
      reference: "Kirchhoff's Current Law"
    },
    {
      id: "par-203",
      difficulty: 4,
      pointValue: 600,
      timeLimit: 16,
      question: "Two 10-ohm resistors are in parallel. What is their total resistance?",
      answers: ["20 Ohms", "10 Ohms", "5 Ohms", "0 Ohms"],
      correctIndex: 2,
      explanation: "Using (R1*R2)/(R1+R2): (10*10)/(10+10) = 100/20 = 5 Ohms. Total R is always less than the smallest branch.",
      reference: "Parallel Circuit Calculation"
    },
    {
      id: "par-204",
      difficulty: 4,
      pointValue: 800,
      timeLimit: 18,
      question: "In a parallel circuit, total current (It) is calculated by:",
      answers: ["Using the smallest branch current", "Averaging all branch currents", "Adding all individual branch currents", "It = I1 x I2 x I3..."],
      correctIndex: 2,
      explanation: "Total current is the sum of the currents in each branch: It = I1 + I2 + I3 + ...",
      reference: "Parallel Circuit Rules"
    },
    {
      id: "par-205",
      difficulty: 5,
      pointValue: 1000,
      timeLimit: 20,
      question: "If one of three bulbs connected in parallel burns out (fails open), what happens to the other two?",
      answers: ["They get brighter", "They get dimmer", "They both go out", "They are unaffected"],
      correctIndex: 3,
      explanation: "Each parallel branch is independent. An open in one branch does not affect the others.",
      reference: "Parallel Circuit Troubleshooting"
    }
  ],

  "Multimeter & Troubleshooting": [
    {
      id: "mtr-201",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "To measure voltage (VDC), a multimeter must be connected:",
      answers: ["In series with the circuit", "In parallel (across) the component", "With the circuit power OFF", "In the AMPS jack"],
      correctIndex: 1,
      explanation: "Voltage is a measurement of potential difference, so the meter must be placed in parallel (across) the points.",
      reference: "Multimeter Usage"
    },
    {
      id: "mtr-202",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 14,
      question: "To measure current (AMPS), a multimeter must be connected:",
      answers: ["In series (in-line) with the circuit", "In parallel (across) the component", "With the circuit power OFF", "In the VOLTS jack"],
      correctIndex: 0,
      explanation: "Current is a measure of flow, so the circuit must be opened and the meter placed in series (in-line).",
      reference: "Multimeter Usage"
    },
    {
      id: "mtr-203",
      difficulty: 4,
      pointValue: 600,
      timeLimit: 16,
      question: "What is the most critical safety step before measuring resistance (Ohms)?",
      answers: ["Set the meter to the highest range", "Verify the meter's battery is good", "Ensure all circuit power is OFF", "Use alligator clips for safety"],
      correctIndex: 2,
      explanation: "An ohmmeter sends its own voltage. Measuring a powered circuit will, at minimum, destroy the meter.",
      reference: "Multimeter Safety"
    },
    {
      id: "mtr-204",
      difficulty: 4,
      pointValue: 800,
      timeLimit: 18,
      question: "A technician reads 'OL' or 'Infinity' on their ohmmeter when checking a wire. This indicates:",
      answers: ["A 'short circuit' to ground", "A good, low-resistance wire", "An 'open circuit' or break", "The wire has high current"],
      correctIndex: 2,
      explanation: "'OL' (Over Limit) means the resistance is too high to measure, indicating a break (an open circuit).",
      reference: "Troubleshooting Opens"
    },
    {
      id: "mtr-205",
      difficulty: 5,
      pointValue: 1000,
      timeLimit: 20,
      question: "A technician reads 0.2 Ohms when measuring from a wire to the aircraft airframe. This indicates:",
      answers: ["A 'short circuit' to ground", "A good, isolated wire", "An 'open circuit' in the wire", "The wire's normal resistance"],
      correctIndex: 0,
      explanation: "A very low resistance path from a wire to ground (airframe) is the definition of a short circuit.",
      reference: "Troubleshooting Shorts"
    }
  ],

  // ==================== FINAL JEOPARDY ====================

  FINAL: {
    cat: "Applied Circuit Troubleshooting",
    difficulty: 5,
    timeLimit: 30,
    question: "A component does not work. A technician measures 28V at the component's positive terminal and 26V at its ground terminal (relative to airframe). The circuit breaker is NOT tripped. What is the most likely fault?",
    answers: [
      "A short circuit in the power wire",
      "A high-resistance (open) ground connection",
      "A failed (open) component",
      "A shorted (failed) component"
    ],
    correctIndex: 1,
    explanation: "A good ground should read near 0V. Reading 26V on the ground wire means the ground path is open or has high resistance, and the voltage is 'floating' up to the supply voltage.",
    reference: "Troubleshooting Ground Faults"
  }
};


/* ========================================================================
   END OF CUSTOMIZABLE QUESTION BANK SECTION
   ======================================================================== */

/* Game State */
const GameState = {
  TILE_SELECTION: 'TILE_SELECTION',
  QUESTION_READING: 'QUESTION_READING',
  BUZZER_ACTIVE: 'BUZZER_ACTIVE',
  ANSWERING: 'ANSWERING',
  SHOWING_RESULT: 'SHOWING_RESULT',
  DAILY_DOUBLE: 'DAILY_DOUBLE',
  ROUND_TRANSITION: 'ROUND_TRANSITION',
  FINAL_JEOPARDY: 'FINAL_JEOPARDY',
  GAME_OVER: 'GAME_OVER'
};

let gameState = GameState.TILE_SELECTION;
let currentRound = 1; // 1 = Jeopardy, 2 = Double Jeopardy
let tiles = {};
let playerScore = 0, aiScore = 0;
let currentTurn = 'player';
let currentQ = null;
let buzzWinner = null;
let dailyDoubleIds = [];
let questionsLeft = 15;
let aiBuzzTimeout = null;

/* AI Settings */
const AI_DIFFICULTY = {
  easy: { reactionMin: 2000, reactionMax: 3500, accuracy: 0.55, name: 'Easy' },
  medium: { reactionMin: 1500, reactionMax: 2500, accuracy: 0.70, name: 'Medium' },
  hard: { reactionMin: 1000, reactionMax: 2000, accuracy: 0.80, name: 'Hard' },
  expert: { reactionMin: 800, reactionMax: 1500, accuracy: 0.88, name: 'Expert' }
};
let currentDifficulty = 'medium';

/* Timer */
let TMAX = 10, t = TMAX, tInt = null, soundOn = true;
/* Track current Daily Double wager so timeouts score correctly */
let currentDDWager = 0;

/* DOM */
const $ = s => document.querySelector(s);
const catRow = $('#catRow'), qLeft = $('#qLeft');
const pScore = $('#pScore'), aiScoreEl = $('#aiScore');
const playerBox = $('#playerBox'), aiBox = $('#aiBox');
const playerTurn = $('#playerTurn'), aiTurn = $('#aiTurn');
const rows = [$('#valRow1'), $('#valRow2'), $('#valRow3'), $('#valRow4'), $('#valRow5')];
const qCard = $('#qCard'), qCat = $('#qCat'), qValue = $('#qValue'), qText = $('#qText');
const choices = $('#choices'), feedback = $('#feedback'), closeQ = $('#closeQ');
const buzzSection = $('#buzzSection'), playerBuzz = $('#playerBuzz'), aiBuzz = $('#aiBuzz');
const qTimer = $('#qTimer'), tFill = $('#tFill'), tLeft = $('#tLeft');
const ddBadge = $('#ddBadge'), ddModal = $('#ddModal');
const confetti = $('#confetti');
const muteBtn = $('#mute'), difficultyBtn = $('#difficultyBtn');
const fjModal = $('#fjModal'), fjCat = $('#fjCat'), fjStart = $('#fjStart');
const fjPScore = $('#fjPScore'), fjAIScore = $('#fjAIScore'), fjPWager = $('#fjPWager'), fjAIWager = $('#fjAIWager');
const finalCard = $('#finalCard'), finalCat = $('#finalCat'), finalText = $('#finalText');
const finalChoices = $('#finalChoices'), finalFeedback = $('#finalFeedback'), closeFinal = $('#closeFinal');
const gameEndModal = $('#gameEndModal'), endGameTitle = $('#endGameTitle');
const endPlayerScore = $('#endPlayerScore'), endAIScore = $('#endAIScore'), endGameMessage = $('#endGameMessage');
const finalRestartBtn = $('#finalRestartBtn');
const roundIndicator = $('#roundIndicator');
const roundTransition = $('#roundTransition'), transitionTitle = $('#transitionTitle'), transitionSubtitle = $('#transitionSubtitle');

/* Audio */
let AC = null;
function ensureAudio() { if (!AC) { AC = new (window.AudioContext || window.webkitAudioContext)(); } if (AC.state === 'suspended') { AC.resume(); } }
function play(freq = 880, ms = 180, type = 'sine', gain = 0.06) {
  if (!soundOn) return;
  ensureAudio();
  const o = AC.createOscillator(), g = AC.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain; g.gain.setValueAtTime(gain, AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + ms / 1000);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + ms / 1000);
}
function chordOK() { play(987, 140, 'sine', 0.08); setTimeout(() => play(1479, 160, 'sine', 0.07), 110); }
function buzzer() {
  if (!soundOn) return; ensureAudio();
  const o = AC.createOscillator(), g = AC.createGain(); o.type = 'square';
  o.frequency.setValueAtTime(120, AC.currentTime); o.frequency.exponentialRampToValueAtTime(70, AC.currentTime + 0.35);
  g.gain.value = 0.08; g.gain.setValueAtTime(0.08, AC.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + 0.4);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + 0.42);
}
function selectBlip() { play(660, 90, 'triangle', 0.06); }
function tick() { play(660, 45, 'sine', 0.03); }
function buzzSound() { play(800, 200, 'square', 0.1); }

function celebrate() {
  const colors = ["#22c55e", "#3b82f6", "#eab308", "#a855f7", "#f43f5e"];
  for (let i = 0; i < 26; i++) {
    const p = document.createElement('i');
    p.style.left = Math.random() * 100 + '%';
    p.style.top = '-10px';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
    p.style.animationDelay = (Math.random() * 0.2) + 's';
    confetti.appendChild(p);
    setTimeout(() => p.remove(), 1700);
  }
}

function updateTurnIndicator() {
  playerBox.classList.toggle('active', currentTurn === 'player');
  aiBox.classList.toggle('active', currentTurn === 'ai');
  
  if (gameState === GameState.TILE_SELECTION) {
    playerTurn.textContent = currentTurn === 'player' ? 'üëâ Your Turn to Select' : '';
    aiTurn.textContent = currentTurn === 'ai' ? 'üëâ AI is Selecting...' : '';
  } else {
    playerTurn.textContent = '';
    aiTurn.textContent = '';
  }
}

/* Validate the structure up front so bad data fails fast */
function validateBank() {
  const cats = Object.keys(QUESTION_BANK).filter(k => k !== 'FINAL');
  if (cats.length !== 6) throw new Error(`QUESTION_BANK must have exactly 6 categories (+ FINAL). Found ${cats.length}.`);
  cats.forEach(c => {
    const arr = QUESTION_BANK[c];
    if (!Array.isArray(arr) || arr.length !== 5) {
      throw new Error(`Category "${c}" must contain exactly 5 items (has ${Array.isArray(arr) ? arr.length : 'invalid'}).`);
    }
    arr.forEach((q, i) => {
      if (!Array.isArray(q.answers) || q.answers.length !== 4) {
        throw new Error(`"${c}" item ${i+1} must have exactly 4 answers.`);
      }
      if (q.correctIndex < 0 || q.correctIndex > 3) {
        throw new Error(`"${c}" item ${i+1} has invalid correctIndex (expected 0‚Äì3).`);
      }
    });
  });
}

function init() {
  validateBank();

  const allCategoryNames = Object.keys(QUESTION_BANK).filter(k => k !== "FINAL");
  // Get first 3 categories for Round 1
  const round1Categories = allCategoryNames.slice(0, 3);
  
  playerScore = 0;
  aiScore = 0;
  currentRound = 1;
  currentTurn = 'player';
  gameState = GameState.TILE_SELECTION;
  currentQ = null;
  buzzWinner = null;
  aiBuzzTimeout = null;
  dailyDoubleIds = [];
  currentDDWager = 0;

  pScore.textContent = '$' + playerScore;
  aiScoreEl.textContent = '$' + aiScore;
  roundIndicator.textContent = 'ROUND 1: JEOPARDY';

  qCard.classList.remove('show');
  finalCard.classList.remove('show');
  gameEndModal.classList.remove('show');
  ddModal.classList.remove('show');
  fjModal.classList.remove('show');
  roundTransition.classList.remove('show');

  loadRound(round1Categories, 1);
}

function loadRound(categories, roundNum) {
  currentRound = roundNum;
  const baseValues = roundNum === 1 ? [100, 200, 300, 400, 500] : [200, 400, 600, 800, 1000];
  
  tiles = {};
  const allRoundQuestions = [];

  categories.forEach(catName => {
    const pool = QUESTION_BANK[catName] || [];

    // Guard: ensure exactly 5 per category
    if (pool.length !== 5) {
      throw new Error(`Category "${catName}" must have exactly 5 questions (has ${pool.length}).`);
    }

    pool.forEach((q, idx) => {
      const id = `${catName}-${baseValues[idx]}`;
      tiles[id] = { 
        ...q,
        id,
        category: catName,      // store the real category
        used: false,
        pointValue: baseValues[idx]
      };
      allRoundQuestions.push(tiles[id]);
    });
  });

  questionsLeft = categories.length * baseValues.length;
  qLeft.textContent = questionsLeft;

  catRow.innerHTML = '';
  categories.forEach(c => {
    const el = document.createElement('div');
    el.className = 'cat';
    el.textContent = c;
    catRow.appendChild(el);
  });

  rows.forEach((r, i) => {
    r.innerHTML = '';
    const v = baseValues[i];
    categories.forEach(catName => {
      const id = `${catName}-${v}`;
      const t = document.createElement('button');
      t.className = 'tile';
      t.textContent = `$${v}`;
      t.dataset.id = id;

      if (tiles[id]) {
        t.addEventListener('click', () => {
          if (gameState === GameState.TILE_SELECTION && currentTurn === 'player' && !tiles[id].used) {
            openTile(id, t);
          }
        });
      }
      r.appendChild(t);
    });
  });

  // Select Daily Doubles for this round
  const candidates = allRoundQuestions.filter(q => q.difficulty >= 3 && q.pointValue >= (roundNum === 1 ? 300 : 600));
  const numDailyDoubles = roundNum === 1 ? 1 : 2;
  dailyDoubleIds = [];
  
  for (let i = 0; i < numDailyDoubles && candidates.length > 0; i++) {
    const idx = Math.floor(Math.random() * candidates.length);
    dailyDoubleIds.push(candidates[idx].id);
    candidates.splice(idx, 1);
  }

  updateTurnIndicator();
}

function openTile(id, btn) {
  const data = tiles[id];
  if (!data || data.used) return;
  
  data.used = true;
  btn.classList.add('used');
  btn.innerHTML = '‚Äî';
  selectBlip();
  
  const isDailyDouble = dailyDoubleIds.includes(id);
  
  if (isDailyDouble) {
    showDailyDouble(data);
  } else {
    showQuestion(data);
  }
}

function aiSelectTile() {
  const availableTiles = Object.values(tiles).filter(t => !t.used);
  if (availableTiles.length === 0) {
    if (currentRound === 1) {
      startRound2();
    } else {
      openFinalJeopardy();
    }
    return;
  }

  gameState = GameState.TILE_SELECTION;
  updateTurnIndicator();

  availableTiles.forEach(t => {
    const btn = document.querySelector(`[data-id="${t.id}"]`);
    if (btn) btn.classList.add('ai-thinking');
  });

  setTimeout(() => {
    let selected;
    if (aiScore < playerScore - 300) {
      const highValue = availableTiles.filter(t => t.pointValue >= (currentRound === 1 ? 400 : 800));
      selected = highValue.length > 0 ? highValue[Math.floor(Math.random() * highValue.length)] : availableTiles[0];
    } else {
      selected = availableTiles[Math.floor(Math.random() * availableTiles.length)];
    }

    availableTiles.forEach(t => {
      const btn = document.querySelector(`[data-id="${t.id}"]`);
      if (btn) btn.classList.remove('ai-thinking');
    });

    const btn = document.querySelector(`[data-id="${selected.id}"]`);
    openTile(selected.id, btn);
  }, 1000 + Math.random() * 1000);
}

function startRound2() {
  gameState = GameState.ROUND_TRANSITION;
  
  // Determine who starts Round 2 (lower score)
  if (playerScore < aiScore) {
    currentTurn = 'player';
  } else if (aiScore < playerScore) {
    currentTurn = 'ai';
  } else {
    currentTurn = 'player';
  }
  
  transitionTitle.textContent = 'DOUBLE JEOPARDY';
  transitionSubtitle.textContent = 'All values are doubled! ' + (currentTurn === 'player' ? 'You start this round!' : 'AI starts this round!');
  roundTransition.classList.add('show');
  
  setTimeout(() => {
    roundTransition.classList.remove('show');
    roundIndicator.textContent = 'ROUND 2: DOUBLE JEOPARDY';
    
    // Load Round 2 categories (second set of 3)
    const allCategoryNames = Object.keys(QUESTION_BANK).filter(k => k !== "FINAL");
    const round2Categories = allCategoryNames.slice(3, 6);
    
    loadRound(round2Categories, 2);
    
    gameState = GameState.TILE_SELECTION;
    updateTurnIndicator();
    
    if (currentTurn === 'ai') {
      setTimeout(() => aiSelectTile(), 1000);
    }
  }, 3000);
}

function showDailyDouble(data) {
  currentQ = data;
  const isDDOwner = currentTurn;
  
  ddModal.classList.add('show');
  $('#ddWho').innerHTML = isDDOwner === 'player' 
    ? '<div style="color:var(--player);font-weight:700">You found the Daily Double!</div>'
    : '<div style="color:var(--ai);font-weight:700">AI found the Daily Double!</div>';
  
  const score = isDDOwner === 'player' ? playerScore : aiScore;
  $('#ddScoreDisplay').innerHTML = `Current Score: <b class="kpi">$${score}</b>`;
  
  if (isDDOwner === 'player') {
    const maxWager = Math.max(currentRound === 1 ? 1000 : 2000, score);
    $('#ddWagerSection').innerHTML = `
      <div>Wager an amount (min $100, max $${maxWager}):</div>
      <div class="input"><span>$</span><input id="ddWagerInput" type="number" min="100" max="${maxWager}" value="${Math.min(maxWager, currentRound === 1 ? 500 : 1000)}" step="50"></div>
    `;
    $('#ddButtons').innerHTML = '<button id="ddStartBtn" class="btn">Answer Question</button>';
    $('#ddStartBtn').addEventListener('click', () => {
      const wager = Math.max(100, Math.min(maxWager, Number($('#ddWagerInput').value) || 100));
      ddModal.classList.remove('show');
      showQuestion(data, true, wager);
    });
  } else {
    const maxWager = Math.max(currentRound === 1 ? 1000 : 2000, score);
    const aiWager = Math.floor(maxWager * (0.3 + Math.random() * 0.5));
    $('#ddWagerSection').innerHTML = `<div>AI is considering their wager...</div>`;
    $('#ddButtons').innerHTML = '';
    
    setTimeout(() => {
      $('#ddWagerSection').innerHTML = `<div>AI wagers: <b class="kpi">$${aiWager}</b></div>`;
      setTimeout(() => {
        ddModal.classList.remove('show');
        showQuestion(data, true, aiWager);
      }, 1500);
    }, 2000);
  }
}

function showQuestion(data, isDailyDouble = false, ddWager = 0) {
  currentQ = data;
  gameState = GameState.QUESTION_READING;
  buzzWinner = null;
  currentDDWager = isDailyDouble ? ddWager : 0; // remember DD wager
  
  qCard.classList.add('show');
  
  // Use stored category instead of parsing the id
  const catName = data.category;
  qCat.textContent = catName;
  qValue.textContent = '$' + data.pointValue;
  qText.textContent = data.question;
  choices.innerHTML = '';
  feedback.innerHTML = '';
  closeQ.classList.add('hidden');
  buzzSection.classList.add('hidden');
  ddBadge.style.display = isDailyDouble ? 'inline-block' : 'none';
  
  if (isDailyDouble) {
    qTimer.style.visibility = 'visible';
    startAnswerTimer(data.timeLimit || 15);
    
    setTimeout(() => {
      gameState = GameState.ANSWERING;
      showAnswerChoices(isDailyDouble, ddWager);
    }, 2000);
  } else {
    qTimer.style.visibility = 'hidden';
    
    setTimeout(() => {
      gameState = GameState.BUZZER_ACTIVE;
      showBuzzerSection();
    }, 3000);
  }
}

function showBuzzerSection() {
  buzzSection.classList.remove('hidden');
  playerBuzz.disabled = false;
  playerBuzz.classList.remove('winner');
  aiBuzz.classList.remove('winner');
  buzzSound();
  
  const aiSettings = AI_DIFFICULTY[currentDifficulty];
  const aiReactionTime = aiSettings.reactionMin + Math.random() * (aiSettings.reactionMax - aiSettings.reactionMin);
  
  let playerBuzzed = false;
  
  playerBuzz.onclick = () => {
    if (gameState !== GameState.BUZZER_ACTIVE || playerBuzzed) return;
    playerBuzzed = true;
    buzzWinner = 'player';
    if (aiBuzzTimeout) clearTimeout(aiBuzzTimeout);
    handleBuzzWin();
  };
  
  aiBuzzTimeout = setTimeout(() => {
    if (gameState === GameState.BUZZER_ACTIVE && !playerBuzzed) {
      buzzWinner = 'ai';
      handleBuzzWin();
    }
  }, aiReactionTime);
}

function handleBuzzWin() {
  gameState = GameState.ANSWERING;
  playerBuzz.disabled = true;
  buzzSound();
  
  if (buzzWinner === 'player') {
    playerBuzz.classList.add('winner');
  } else {
    aiBuzz.classList.add('winner');
  }
  
  setTimeout(() => {
    buzzSection.classList.add('hidden');
    qTimer.style.visibility = 'visible';
    startAnswerTimer(currentQ.timeLimit || 10);
    showAnswerChoices(false, 0);
  }, 1000);
}

function showAnswerChoices(isDailyDouble, ddWager) {
  choices.innerHTML = '';
  
  currentQ.answers.forEach((t, idx) => {
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = '<strong>' + String.fromCharCode(65 + idx) + '.</strong> ' + t;
    b.dataset.idx = idx;
    
    if (isDailyDouble) {
      if (currentTurn === 'player') {
        b.addEventListener('click', () => handleAnswer(idx, true, ddWager));
      } else {
        b.disabled = true;
      }
    } else {
      if (buzzWinner === 'player') {
        b.addEventListener('click', () => handleAnswer(idx, false, 0));
      } else {
        b.disabled = true;
      }
    }
    
    choices.appendChild(b);
  });
  
  if ((isDailyDouble && currentTurn === 'ai') || (!isDailyDouble && buzzWinner === 'ai')) {
    const aiSettings = AI_DIFFICULTY[currentDifficulty];
    const thinkTime = 1000 + Math.random() * 2000;
    
    setTimeout(() => {
      const correctAnswer = currentQ.correctIndex;
      let aiAnswer;
      
      if (Math.random() < aiSettings.accuracy) {
        aiAnswer = correctAnswer;
      } else {
        const wrongAnswers = [0, 1, 2, 3].filter(i => i !== correctAnswer);
        aiAnswer = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
      }
      
      handleAnswer(aiAnswer, isDailyDouble, ddWager);
    }, thinkTime);
  }
}

function handleAnswer(answerIdx, isDailyDouble, ddWager) {
  stopTimer();
  gameState = GameState.SHOWING_RESULT;
  
  [...choices.children].forEach(b => b.disabled = true);
  
  const correct = currentQ.correctIndex;
  const isCorrect = (answerIdx === correct);
  const answerer = isDailyDouble ? currentTurn : buzzWinner;
  const value = isDailyDouble ? ddWager : currentQ.pointValue;
  
  if (isCorrect) {
    choices.children[correct].classList.add('correct');
    if (answerer === 'player') {
      playerScore += value;
      pScore.textContent = '$' + playerScore;
    } else {
      aiScore += value;
      aiScoreEl.textContent = '$' + aiScore;
    }
    chordOK();
    celebrate();
    currentTurn = answerer;
  } else {
    if (answerIdx >= 0 && choices.children[answerIdx]) choices.children[answerIdx].classList.add('wrong');
    choices.children[correct].classList.add('correct');
    if (answerer === 'player') {
      playerScore -= value;
      pScore.textContent = '$' + playerScore;
    } else {
      aiScore -= value;
      aiScoreEl.textContent = '$' + aiScore;
    }
    buzzer();
    
    if (!isDailyDouble) {
      currentTurn = answerer === 'player' ? 'ai' : 'player';
    }
  }
  
  showExplanation(currentQ, isCorrect, answerer);
  closeQ.classList.remove('hidden');
}

function showExplanation(question, wasCorrect, answerer) {
  const answererName = answerer === 'player' ? 'You' : 'AI';
  const resultText = wasCorrect ? `‚úì ${answererName} answered correctly!` : `‚úó ${answererName} answered incorrectly`;
  
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'explanation';
  explanationDiv.innerHTML = `
    <h4>${resultText}</h4>
    <p><strong>Explanation:</strong> ${question.explanation}</p>
    ${question.reference ? `<p><small>üìö Reference: ${question.reference}</small></p>` : ''}
  `;
  feedback.appendChild(explanationDiv);
}

closeQ.addEventListener('click', () => {
  qCard.classList.remove('show');
  closeQ.classList.add('hidden');
  checkEndOrNext();
});

function checkEndOrNext() {
  questionsLeft = Object.values(tiles).filter(t => !t.used).length;
  qLeft.textContent = questionsLeft;
  
  if (questionsLeft === 0) {
    if (currentRound === 1) {
      startRound2();
    } else {
      openFinalJeopardy();
    }
  } else {
    gameState = GameState.TILE_SELECTION;
    updateTurnIndicator();
    
    if (currentTurn === 'ai') {
      aiSelectTile();
    }
  }
}

function openFinalJeopardy() {
  gameState = GameState.FINAL_JEOPARDY;
  fjCat.textContent = QUESTION_BANK.FINAL.cat;
  fjPScore.textContent = '$' + playerScore;
  fjAIScore.textContent = '$' + aiScore;
  fjPWager.max = Math.max(0, playerScore);
  fjPWager.value = Math.max(0, Math.min(playerScore, Math.floor(playerScore / 2)));
  fjAIWager.textContent = '$???';
  fjModal.classList.add('show');
}

fjStart.addEventListener('click', () => {
  const playerWager = Math.max(0, Math.min(playerScore, Number(fjPWager.value) || 0));
  
  let aiWager;
  if (aiScore > playerScore) {
    aiWager = Math.max(0, Math.min(aiScore, playerScore * 2 - aiScore + 100));
  } else {
    aiWager = Math.max(0, aiScore);
  }
  aiWager = Math.max(0, Math.min(aiScore, aiWager));
  
  fjModal.classList.remove('show');
  renderFinalQuestion(playerWager, aiWager);
});

function renderFinalQuestion(playerWager, aiWager) {
  finalCard.classList.add('show');
  finalCat.textContent = QUESTION_BANK.FINAL.cat;
  finalText.textContent = QUESTION_BANK.FINAL.question;
  finalChoices.innerHTML = '';
  finalFeedback.innerHTML = '';
  closeFinal.classList.add('hidden');
  
  QUESTION_BANK.FINAL.answers.forEach((t, idx) => {
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = `<strong>${String.fromCharCode(65 + idx)}.</strong> ${t}`;
    b.addEventListener('click', () => {
      handleFinalAnswer(idx, playerWager, aiWager);
    });
    finalChoices.appendChild(b);
  });
}

function handleFinalAnswer(playerAnswerIdx, playerWager, aiWager) {
  [...finalChoices.children].forEach(b => b.disabled = true);
  
  const correct = QUESTION_BANK.FINAL.correctIndex;
  const playerCorrect = (playerAnswerIdx === correct);
  
  const aiSettings = AI_DIFFICULTY[currentDifficulty];
  const aiCorrect = Math.random() < (aiSettings.accuracy * 0.85);
  
  finalChoices.children[playerAnswerIdx].classList.add(playerCorrect ? 'correct' : 'wrong');
  if (!playerCorrect) {
    finalChoices.children[correct].classList.add('correct');
  }
  
  if (playerCorrect) {
    playerScore += playerWager;
  } else {
    playerScore -= playerWager;
  }
  
  if (aiCorrect) {
    aiScore += aiWager;
  } else {
    aiScore -= aiWager;
  }
  
  pScore.textContent = '$' + playerScore;
  aiScoreEl.textContent = '$' + aiScore;
  
  const expDiv = document.createElement('div');
  expDiv.className = 'explanation';
  expDiv.innerHTML = `
    <h4>Final Jeopardy Results</h4>
    <p><strong>Your answer:</strong> ${playerCorrect ? '‚úì Correct!' : '‚úó Incorrect'} (Wagered $${playerWager})</p>
    <p><strong>AI answer:</strong> ${aiCorrect ? '‚úì Correct!' : '‚úó Incorrect'} (Wagered $${aiWager})</p>
    <p><strong>Explanation:</strong> ${QUESTION_BANK.FINAL.explanation}</p>
    ${QUESTION_BANK.FINAL.reference ? `<p><small>üìö Reference: ${QUESTION_BANK.FINAL.reference}</small></p>` : ''}
  `;
  finalFeedback.appendChild(expDiv);
  
  if (playerCorrect) chordOK();
  else buzzer();
  
  closeFinal.classList.remove('hidden');
}

closeFinal.addEventListener('click', () => {
  finalCard.classList.remove('show');
  endGame();
});

function endGame() {
  gameState = GameState.GAME_OVER;
  gameEndModal.classList.add('show');
  
  endPlayerScore.textContent = '$' + playerScore;
  endAIScore.textContent = '$' + aiScore;
  
  if (playerScore > aiScore) {
    endGameTitle.textContent = 'üèÜ YOU WIN!';
    endGameMessage.textContent = `Congratulations! You defeated the AI ${AI_DIFFICULTY[currentDifficulty].name} opponent by $${playerScore - aiScore}. Excellent knowledge!`;
    celebrate();
  } else if (aiScore > playerScore) {
    endGameTitle.textContent = 'ü§ñ AI WINS!';
    endGameMessage.textContent = `The AI ${AI_DIFFICULTY[currentDifficulty].name} opponent won by $${aiScore - playerScore}. Review the explanations and try again!`;
  } else {
    endGameTitle.textContent = 'ü§ù TIE GAME!';
    endGameMessage.textContent = `You and the AI ${AI_DIFFICULTY[currentDifficulty].name} opponent tied! That's impressive.`;
  }
}

function startAnswerTimer(timeLimit) {
  stopTimer();
  TMAX = timeLimit;
  t = TMAX;
  tLeft.textContent = t;
  tFill.style.transition = 'none';
  tFill.style.width = '100%';
  void tFill.offsetWidth;
  tFill.style.transition = 'width 1s linear';
  
  tInt = setInterval(() => {
    t--;
    tLeft.textContent = t;
    const percent = (t / TMAX) * 100;
    tFill.style.width = percent + '%';
    if (t <= 5 && t > 0) tick();
    if (t <= 0) {
      stopTimer();
      const isDD = ddBadge.style.display !== 'none';
      handleAnswer(-1, isDD, isDD ? currentDDWager : 0); // use stored DD wager on timeout
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(tInt);
  tInt = null;
}

muteBtn.addEventListener('click', () => {
  soundOn = !soundOn;
  muteBtn.textContent = soundOn ? 'üîà Sound' : 'üîá Muted';
});

difficultyBtn.addEventListener('click', () => {
  const difficulties = ['easy', 'medium', 'hard', 'expert'];
  const currentIdx = difficulties.indexOf(currentDifficulty);
  currentDifficulty = difficulties[(currentIdx + 1) % difficulties.length];
  difficultyBtn.textContent = `AI: ${AI_DIFFICULTY[currentDifficulty].name}`;
});

finalRestartBtn.addEventListener('click', init);
document.addEventListener('click', () => { ensureAudio(); }, { once: true });

init();
</script>
</body>
</html>

              <!-- ========== END OF REPLACEMENT SECTION ========== -->
            "></iframe>
          </div>
          <div class="viewer-footer">System Status: Online // Module: Practice Test</div>
        </div>
      </div>

      <!-- Jeopardy Tab -->
      <div id="jeopardy-view" class="tab-view">
        <button class="back-button" onclick="showTab('home')">‚óÑ Back</button>
        <div class="viewer-container">
          <div class="viewer-header">
            <div class="status-indicator"></div>
            <h2>Avionics Jeopardy - Game Mode</h2>
          </div>
          <div class="viewer-body">
<iframe class="viewer-iframe" id="jeopardy-iframe" src="Jeopardy Master.html"></iframe>
	<html lang="en">
	<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1"><title>Jeopardy ‚Äî Player vs AI</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
	<style>
	  :root {
	    --bg: #111827;
	    --panel: #1f2937;
	    --board: #111827;
	    --tile: #4f46e5;
	    --tile-hover: #6366f1;
	    --tile-text: #f59e0b;
	    --ink: #e5e7eb;
	    --ink-dim: #9ca3af;
	    --border: #374151;
	    --ok: #22c55e;
	    --warn: #f59e0b;
	    --err: #ef4444;
	    --player: #3b82f6;
	    --ai: #f43f5e;
	    --font-heading: 'Montserrat', sans-serif;
	    --font-body: 'Roboto', sans-serif;
	  }
	  *{box-sizing:border-box}
	  body{
	    margin:0;
	    font-family: var(--font-body);
	    background: var(--bg);
	    color: var(--ink);
	    -webkit-font-smoothing: antialiased;
	    -moz-osx-font-smoothing: grayscale;
	  }
	  .wrap{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
	  .top{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
	  .badge{padding:6px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--border);color:var(--ink-dim); font-size: 0.9rem; font-weight: 700;}
	
	  /* Scores Section */
	  .scores{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
	  .player-box{
	    background:var(--panel);
	    border:2px solid var(--player);
	    border-radius:12px;
	    padding:16px;
	    text-align:center;
	  }
	  .player-box.active{
	    box-shadow: 0 0 20px var(--player);
	    animation: pulse 1.5s ease-in-out infinite;
	  }
	  .ai-box{
	    background:var(--panel);
	    border:2px solid var(--ai);
	    border-radius:12px;
	    padding:16px;
	    text-align:center;
	  }
	  .ai-box.active{
	    box-shadow: 0 0 20px var(--ai);
	    animation: pulse 1.5s ease-in-out infinite;
	  }
	  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
	  .player-name{font-size:0.9rem;color:var(--ink-dim);margin-bottom:4px}
	  .player-score{font-size:2rem;font-weight:900;color:var(--player);font-family:var(--font-heading)}
	  .ai-score{font-size:2rem;font-weight:900;color:var(--ai);font-family:var(--font-heading)}
	  .turn-indicator{margin-top:8px;font-size:0.85rem;font-weight:700;color:var(--tile-text)}
	
	  .board{
	    background: var(--panel);
	    border-radius: 16px;
	    border: 1px solid var(--border);
	    padding: 16px;
	    display: grid;
	    gap: 12px;
	    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3), 0 8px 10px -6px rgba(0,0,0,0.3);
	  }
	  .row{display:grid;gap:12px}
	  .row-3{grid-template-columns:repeat(3,1fr)}
	  .tile{
	    display: grid;
	    place-items: center;
	    padding: 18px;
	    border-radius: 12px;
	    background: var(--tile);
	    border: none;
	    color: var(--tile-text);
	    font-family: var(--font-heading);
	    font-weight: 900;
	    font-size: 1.6rem;
	    cursor: pointer;
	    min-height: 80px;
	    text-align: center;
	    user-select: none;
	    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
	    transition: transform 0.15s ease, background-color 0.15s ease, box-shadow 0.15s ease;
	    position: relative;
	  }
	  .tile:not(.used):hover{
	    transform: scale(1.05);
	    background: var(--tile-hover);
	    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
	  }
	  .tile.used{
	    background: rgba(31, 41, 55, 0.5);
	    color: #6b7280;
	    cursor: not-allowed;
	    text-shadow: none;
	  }
	  .tile.ai-thinking{
	    animation: ai-glow 0.5s ease-in-out infinite alternate;
	  }
	  @keyframes ai-glow{
	    from{box-shadow: 0 0 10px var(--ai)}
	    to{box-shadow: 0 0 25px var(--ai)}
	  }
	  .cats{gap:12px;margin-bottom:8px}
	  .cat{
	    display: grid;
	    place-items: center;
	    padding: 10px;
	    border-radius: 10px;
	    background: var(--bg);
	    color: var(--ink);
	    	border: 1px solid var(--border);
	    font-family: var(--font-heading);
    	font-weight: 700;
    	min-height: 50px;
    	text-align: center;
    	font-size: 0.9rem;
  	}	

  	.round-indicator{
  	  padding: 8px 16px;
  	  border-radius: 999px;
  	  background: var(--tile);
  	  border: 2px solid var(--tile-hover);
  	  color: white;
  	  font-weight: 900;
  	  font-size: 0.95rem;
  	  text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
  }

  /* Buzzer Section */
  .buzzer-section{
    display:grid;
    gap:12px;
    margin-top:16px;
    grid-template-columns: 1fr 1fr;
  }
  .buzz-btn{
    padding: 20px;
    border-radius: 12px;
    font-size: 1.3rem;
    font-weight: 900;
    font-family: var(--font-heading);
    cursor: pointer;
    border: 3px solid;
    transition: all 0.15s ease;
    text-transform: uppercase;
  }
  .player-buzz{
    background: var(--player);
    border-color: var(--player);
    color: white;
  }
  .player-buzz:hover:not(:disabled){
    transform: scale(1.05);
    box-shadow: 0 0 30px var(--player);
  }
  .player-buzz:disabled{
    opacity: 0.3;
    cursor: not-allowed;
  }
  .player-buzz.winner{
    animation: buzz-winner 0.5s ease;
    box-shadow: 0 0 40px var(--player);
  }
  .ai-buzz{
    background: var(--ai);
    border-color: var(--ai);
    color: white;
    cursor: default;
  }
  .ai-buzz.winner{
    animation: buzz-winner 0.5s ease;
    box-shadow: 0 0 40px var(--ai);
  }
  @keyframes buzz-winner{
    0%,100%{transform:scale(1)}
    50%{transform:scale(1.1)}
  }

  .qhead{display:flex;align-items:center;justify-content:space-between;gap:10px; flex-wrap: wrap;}
  .qtext{font-size:1.2rem;line-height:1.6;color:#ffffff; font-weight: 500; margin: 8px 0;}
  .choices{display:grid;gap:10px;margin-top:16px}
  .choice{
    display:flex;gap:12px;align-items:center;padding:14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--ink);cursor:pointer;
    transition: transform 0.15s ease, background-color 0.15s ease;
    text-align: left;
    font-size: 1rem;
    line-height: 1.4;
  }
  .choice:hover:not(:disabled){background:#374151; transform: translateY(-2px);}
  .choice.correct{border-color:var(--ok); background:rgba(34, 197, 94, 0.1); color: var(--ok);}
  .choice.wrong{border-color:var(--err); background:rgba(239, 68, 68, 0.1); color: var(--err);}
  .choice > strong { color: var(--tile-text); }
  .choice.correct > strong, .choice.wrong > strong { color: inherit; }

  .explanation{
    margin-top: 16px;
    padding: 16px;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    border-radius: 10px;
    line-height: 1.6;
  }
  .explanation h4{
    margin: 0 0 8px 0;
    color: #3b82f6;
    font-size: 1.1rem;
  }
  .explanation p{
    margin: 8px 0;
    color: var(--ink);
  }
  .explanation small{
    color: var(--ink-dim);
    font-style: italic;
  }

  .meta{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .kpi{font-variant-numeric:tabular-nums;font-weight:700; color: var(--tile-text);}
  .btn{
    padding: 10px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    background: #374151;
    color: var(--ink);
    cursor: pointer;
    font-weight: 700;
    transition: transform 0.15s ease, background-color 0.15s ease;
  }
  .btn:hover{background: #4b5563; transform: translateY(-2px);}
  .btn.ghost{background:transparent;color:var(--ink-dim);border-color:var(--border)}
  .btn.ghost:hover{color: var(--ink); background: var(--panel);}
  .center{text-align:center}
  .hidden{display:none}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  
  .timer {
    display:flex;
    align-items:center;
    gap:8px;
  }
  #qTimer {
    background:var(--bg);
    border:1px solid var(--border);
    padding: 6px 12px;
    border-radius: 999px;
  }
  .bar{height:10px;background:var(--bg);border-radius:999px;overflow:hidden;width:100px;border:1px solid var(--border)}
  .bar>div{
    height:100%;
    background:linear-gradient(90deg, var(--ok), var(--warn), var(--err));
    width:100%;
    transition: width 1s linear;
  }

  .overlay{position:fixed;inset:0;pointer-events:none; z-index: 200;}
  .confetti i{position:absolute;width:8px;height:14px;opacity:.95;animation:fall 1.6s linear forwards}
  @keyframes fall{to{transform:translateY(120vh) rotate(360deg);opacity:.2}}

  .modal{
    position:fixed;
    inset:0;
    background:rgba(17, 24, 39, 0.9);
    backdrop-filter: blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:100;
    opacity: 0;
    transform: scale(0.98);
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s;
  }
  .modal.show{
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0s;
  }
  .card{
    background: var(--panel);
    color: var(--ink);
    border: 1px solid var(--border);
    border-radius: 16px;
    max-width: 650px;
    width: 100%;
    padding: 24px;
    display: grid;
    gap: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    max-height: 90vh;
    overflow-y: auto;
  }
  .card h2{margin:0;font-family: var(--font-heading); font-size:1.6rem; color: var(--tile-text);}
  .input{display:flex;gap:8px;align-items:center}
  .input input{flex:1;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--ink); font-size: 1rem;}

  #gameEndModal .card {
      padding: 0;
      overflow: hidden;
      text-align: center;
      max-width: 500px;
  }
  .endGameContent {
      padding: 24px;
      display: grid;
      gap: 12px;
  }
  .endGameContent h2 {
      font-size: 2.2rem;
      color: var(--tile-text);
      margin-bottom: 5px;
      text-shadow: 2px 2px 5px rgba(0,0,0,0.4);
  }
  .endGameContent .final-scores{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 16px 0;
  }
  .endGameContent .score-box{
      padding: 12px;
      border-radius: 10px;
      border: 2px solid;
  }
  .endGameContent .player-final{
      border-color: var(--player);
      background: rgba(59, 130, 246, 0.1);
  }
  .endGameContent .ai-final{
      border-color: var(--ai);
      background: rgba(244, 63, 94, 0.1);
  }
  .endGameContent p {
      color: var(--ink-dim);
      line-height: 1.5;
  }
  #finalRestartBtn {
      background: var(--tile);
      color: #fff;
      font-size: 1.1rem;
      padding: 12px 24px;
      border: none;
      box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
  }
  #finalRestartBtn:hover {
      background: var(--tile-hover);
      box-shadow: 0 6px 15px rgba(79, 70, 229, 0.5);
  }

  .round-transition{
    position:fixed;
    inset:0;
    background:rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(8px);
    display:flex;
    flex-direction: column;
    align-items:center;
    justify-content:center;
    z-index:150;
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0s 0.3s;
  }
  .round-transition.show{
    opacity: 1;
    pointer-events: auto;
    visibility: visible;
    transition: opacity 0.3s ease, visibility 0s 0s;
  }
  .round-transition h1{
    font-family: var(--font-heading);
    font-size: 3.5rem;
    color: var(--tile-text);
    margin: 0;
    text-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
    animation: glow 2s ease-in-out infinite;
  }
  @keyframes glow{
    0%,100%{text-shadow: 0 0 30px rgba(245, 158, 11, 0.5)}
    50%{text-shadow: 0 0 50px rgba(245, 158, 11, 0.8)}
  }
  .round-transition p{
    font-size: 1.3rem;
    color: var(--ink);
    margin-top: 16px;
  }

  @media (max-width:780px){ 
    .row-3{grid-template-columns:1fr} 
    .tile{min-height:56px} 
    .qtext{font-size:1.05rem}
    .scores{grid-template-columns:1fr}
    .buzzer-section{grid-template-columns:1fr}
    .round-transition h1{font-size: 2.5rem}
  }
</style>
</head>
<body>

<div class="wrap">
  <div class="top">
    <div class="badge">Electrical Systems Jeopardy ‚Äî Player vs AI</div>
    <div class="meta">
      <span class="round-indicator" id="roundIndicator">ROUND 1: JEOPARDY</span>
      <span>Tiles left: <span class="kpi" id="qLeft">15</span></span>
      <button id="mute" class="btn ghost">üîà Sound</button>
      <button id="difficultyBtn" class="btn ghost">AI: Medium</button>
    </div>
  </div>

  <div class="scores">
    <div class="player-box" id="playerBox">
      <div class="player-name">YOU</div>
      <div class="player-score" id="pScore">$0</div>
      <div class="turn-indicator" id="playerTurn"></div>
    </div>
    <div class="ai-box" id="aiBox">
      <div class="player-name">AI OPPONENT</div>
      <div class="ai-score" id="aiScore">$0</div>
      <div class="turn-indicator" id="aiTurn"></div>
    </div>
  </div>

  <div class="board">
    <div class="cats row row-3" id="catRow"></div>
    <div class="row row-3" id="valRow1"></div>
    <div class="row row-3" id="valRow2"></div>
    <div class="row row-3" id="valRow3"></div>
    <div class="row row-3" id="valRow4"></div>
    <div class="row row-3" id="valRow5"></div>
  </div>
</div>

<div class="round-transition" id="roundTransition">
  <h1 id="transitionTitle">DOUBLE JEOPARDY</h1>
  <p id="transitionSubtitle">All values are doubled!</p>
</div>

<div class="modal" id="qCard">
  <div class="card">
    <div class="qhead">
      <div class="meta"><span id="qCat" class="badge"></span><span id="qValue" class="badge"></span></div>
      <div class="meta">
        <div class="timer" id="qTimer">
          <span>Time:</span>
          <div class="bar"><div id="tFill"></div></div>
          <span class="kpi" id="tLeft">10</span>s
        </div>
        <span class="badge" id="ddBadge" style="display:none;background:var(--warn);border-color:var(--warn);color:#111;">DAILY DOUBLE</span>
      </div>
    </div>
    <div class="qtext" id="qText">Question</div>
    
    <div id="buzzSection" class="buzzer-section hidden">
      <button class="buzz-btn player-buzz" id="playerBuzz" disabled>üîµ BUZZ IN!</button>
      <button class="buzz-btn ai-buzz" id="aiBuzz">üî¥ AI</button>
    </div>

    <div class="choices" id="choices"></div>
    <div id="feedback" class="center"></div>
    <div class="center" style="margin-top:10px;">
      <button id="closeQ" class="btn hidden">Continue</button>
    </div>
  </div>
</div>

<div class="modal" id="finalCard">
  <div class="card">
    <div class="qhead">
      <div class="meta"><span class="badge" id="finalCat">Final Category</span></div>
      <div class="meta"><span class="badge" style="background:#a855f7;border-color:#a855f7;color:#fff;">FINAL JEOPARDY</span></div>
    </div>
    <div class="qtext" id="finalText">Final question text‚Ä¶</div>
    <div class="choices" id="finalChoices"></div>
    <div id="finalFeedback" class="center"></div>
    <div class="center" style="margin-top:10px;">
      <button id="closeFinal" class="btn hidden">See Results</button>
    </div>
  </div>
</div>

<div class="overlay confetti" id="confetti"></div>

<div class="modal" id="ddModal">
  <div class="card">
    <h2 id="ddTitle">DAILY DOUBLE!</h2>
    <div id="ddWho"></div>
    <div id="ddScoreDisplay"></div>
    <div id="ddWagerSection"></div>
    <div class="meta" id="ddButtons"></div>
  </div>
</div>

<div class="modal" id="fjModal">
  <div class="card">
    <h2>FINAL JEOPARDY</h2>
    <div>Category: <b id="fjCat">Category</b></div>
    <div style="margin:16px 0">
      <div style="margin-bottom:8px">Your Score: <b class="kpi" style="color:var(--player)" id="fjPScore">$0</b></div>
      <div class="input"><span>Your Wager: $</span><input id="fjPWager" type="number" min="0" step="50" value="0"></div>
    </div>
    <div style="margin:16px 0">
      <div style="margin-bottom:8px">AI Score: <b class="kpi" style="color:var(--ai)" id="fjAIScore">$0</b></div>
      <div>AI Wager: <b class="kpi" style="color:var(--ai)" id="fjAIWager">$???</b> (Hidden)</div>
    </div>
    <div class="meta">
      <button id="fjStart" class="btn">Reveal Final Question</button>
    </div>
  </div>
</div>

<div class="modal" id="gameEndModal">
  <div class="card">
    <div class="endGameContent">
      <h2 id="endGameTitle">Game Over!</h2>
      <div class="final-scores">
        <div class="score-box player-final">
          <div style="font-size:0.9rem;color:var(--ink-dim)">YOU</div>
          <div class="kpi" style="color:var(--player);font-size:1.8rem" id="endPlayerScore">$0</div>
        </div>
        <div class="score-box ai-final">
          <div style="font-size:0.9rem;color:var(--ink-dim)">AI</div>
          <div class="kpi" style="color:var(--ai);font-size:1.8rem" id="endAIScore">$0</div>
        </div>
      </div>
      <p id="endGameMessage">Thanks for playing!</p>
      <button id="finalRestartBtn" class="btn">Play Again</button>
    </div>
  </div>
</div>

<script>
/* ========================================================================
   QUESTION BANK - CUSTOMIZE THIS SECTION FOR DIFFERENT JEOPARDY GAMES
   ========================================================================

   TO CREATE A NEW JEOPARDY GAME:
   1. Keep the structure exactly the same
   2. Change category names (must have exactly 6 categories + FINAL)
   3. Update questions, answers, and explanations for your topic
   4. Each category needs exactly 5 questions
   5. Round 1 categories use base values: $100, $200, $300, $400, $500
   6. Round 2 categories use doubled values: $200, $400, $600, $800, $1000

   STRUCTURE:
   - First 3 categories = Round 1 (Jeopardy)
   - Next 3 categories = Round 2 (Double Jeopardy) 
   - FINAL = Final Jeopardy question

   ======================================================================== */

const QUESTION_BANK = {
  // ==================== ROUND 1: JEOPARDY ====================

  "DC Concepts": [
    {
      id: "dc-001",
      difficulty: 1,
      pointValue: 100,
      timeLimit: 10,
      question: "This is the unit of measurement for electrical 'pressure' or potential difference.",
      answers: ["Amperes (Amps)", "Ohms (Œ©)", "Volts (V)", "Watts (W)"],
      correctIndex: 2,
      explanation: "Voltage (Volts) is the electrical pressure that causes current to flow.",
      reference: "Fundamentals of DC"
    },
    {
      id: "dc-002",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "This is the unit of measurement for the rate of electron flow in a circuit.",
      answers: ["Amperes (Amps)", "Ohms (Œ©)", "Volts (V)", "Watts (W)"],
      correctIndex: 0,
      explanation: "Current (Amperes) is the measure of how many electrons flow past a point per second.",
      reference: "Fundamentals of DC"
    },
    {
      id: "dc-003",
      difficulty: 3,
      pointValue: 300,
      timeLimit: 14,
      question: "A material, like rubber or plastic, that strongly opposes the flow of current is called:",
      answers: ["A conductor", "A semiconductor", "A resistor", "An insulator"],
      correctIndex: 3,
      explanation: "Insulators have very high resistance and are used to prevent current from flowing where it is not wanted.",
      reference: "Conductors vs. Insulators"
    },
    {
      id: "dc-004",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 15,
      question: "This is the unit of measurement for the opposition to current flow.",
      answers: ["Amperes (Amps)", "Ohms (Œ©)", "Volts (V)", "Watts (W)"],
      correctIndex: 1,
      explanation: "Resistance (Ohms) is the property that opposes the flow of current.",
      reference: "Fundamentals of DC"
    },
    {
      id: "dc-005",
      difficulty: 4,
      pointValue: 500,
      timeLimit: 18,
      question: "In 'Direct Current' (DC), the electrons flow in:",
      answers: ["Two directions, alternating", "One direction only", "A circular, spinning pattern", "High-frequency pulses"],
      correctIndex: 1,
      explanation: "Direct Current (DC) is defined by its unidirectional flow, typically from negative to positive.",
      reference: "AC vs. DC"
    }
  ],

  "Ohm's Law": [
    {
      id: "ohm-001",
      difficulty: 1,
      pointValue: 100,
      timeLimit: 10,
      question: "What is the correct formula for Ohm's Law?",
      answers: ["V = I x R", "R = V x I", "I = V x R", "P = V x I"],
      correctIndex: 0,
      explanation: "Ohm's Law states Voltage (V) equals Current (I) multiplied by Resistance (R).",
      reference: "Ohm's Law Formula"
    },
    {
      id: "ohm-002",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 15,
      question: "A 10-ohm resistor has 2 amps of current flowing through it. What is the voltage drop across it?",
      answers: ["5 Volts", "12 Volts", "0.2 Volts", "20 Volts"],
      correctIndex: 3,
      explanation: "Using V = I x R: 2 Amps * 10 Ohms = 20 Volts.",
      reference: "Ohm's Law Calculation"
    },
    {
      id: "ohm-003",
      difficulty: 3,
      pointValue: 300,
      timeLimit: 15,
      question: "A 28-volt circuit has a resistance of 7 ohms. How much current is flowing?",
      answers: ["4 Amps", "196 Amps", "21 Amps", "0.25 Amps"],
      correctIndex: 0,
      explanation: "Using I = V / R: 28 Volts / 7 Ohms = 4 Amps.",
      reference: "Ohm's Law Calculation"
    },
    {
      id: "ohm-004",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 15,
      question: "A lamp connected to a 14-volt source draws 2 amps. What is the lamp's resistance?",
      answers: ["28 Ohms", "12 Ohms", "7 Ohms", "16 Ohms"],
      correctIndex: 2,
      explanation: "Using R = V / I: 14 Volts / 2 Amps = 7 Ohms.",
      reference: "Ohm's Law Calculation"
    },
    {
      id: "ohm-005",
      difficulty: 4,
      pointValue: 500,
      timeLimit: 18,
      question: "In a circuit with constant voltage, if you double the resistance, what happens to the current?",
      answers: ["It doubles", "It stays the same", "It is cut in half", "It becomes zero"],
      correctIndex: 2,
      explanation: "Current and resistance are inversely proportional (I = V/R). If R doubles, I is halved.",
      reference: "Ohm's Law Relationships"
    }
  ],

  "The Power Law": [
    {
      id: "pwr-001",
      difficulty: 1,
      pointValue: 100,
      timeLimit: 10,
      question: "What is the basic formula for electrical power (Watt's Law)?",
      answers: ["P = I x R", "P = V / I", "P = V x I", "P = V / R"],
      correctIndex: 2,
      explanation: "Power (P) in Watts equals Voltage (V) multiplied by Current (I).",
      reference: "Power Law Formula"
    },
    {
      id: "pwr-002",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 15,
      question: "A 28V circuit is drawing 10 amps. How much power is being consumed?",
      answers: ["2.8 Watts", "280 Watts", "38 Watts", "0.35 Watts"],
      correctIndex: 1,
      explanation: "Using P = V x I: 28 Volts * 10 Amps = 280 Watts.",
      reference: "Power Law Calculation"
    },
    {
      id: "pwr-003",
      difficulty: 3,
      pointValue: 300,
      timeLimit: 15,
      question: "What is the alternate formula for power when you only know current and resistance?",
      answers: ["P = I¬≤ / R", "P = R¬≤ / I", "P = I x R¬≤", "P = I¬≤ x R"],
      correctIndex: 3,
      explanation: "Since V = IR, substitute (IR) for V in P=VI, which gives P = (IR)I, or P = I¬≤R.",
      reference: "Power Law Formula"
    },
    {
      id: "pwr-004",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 18,
      question: "A 100-ohm resistor has 2 amps flowing through it. How much power is it dissipating?",
      answers: ["200 Watts", "50 Watts", "400 Watts", "0.02 Watts"],
      correctIndex: 2,
      explanation: "Using P = I¬≤ x R: (2 Amps * 2 Amps) * 100 Ohms = 400 Watts.",
      reference: "Power Law Calculation"
    },
    {
      id: "pwr-005",
      difficulty: 4,
      pointValue: 500,
      timeLimit: 18,
      question: "What is the alternate formula for power when you only know voltage and resistance?",
      answers: ["P = V¬≤ / R", "P = R¬≤ / V", "P = V x R¬≤", "P = V¬≤ x R"],
      correctIndex: 0,
      explanation: "Since I = V/R, substitute (V/R) for I in P=VI, which gives P = V(V/R), or P = V¬≤/R.",
      reference: "Power Law Formula"
    }
  ],

  // ==================== ROUND 2: DOUBLE JEOPARDY ====================

  "Series Circuits": [
    {
      id: "ser-201",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "In a series circuit, the total resistance (Rt) is calculated by:",
      answers: ["Averaging all resistors", "Using the smallest resistor value", "Adding all individual resistances", "Rt = (R1*R2)/(R1+R2)"],
      correctIndex: 2,
      explanation: "In a series circuit, resistances add up: Rt = R1 + R2 + R3 + ...",
      reference: "Series Circuit Rules"
    },
    {
      id: "ser-202",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 14,
      question: "What is the rule for current in a series circuit?",
      answers: ["It is the same through all components", "It divides at each component", "It is highest at the last component", "It is zero at the end of the loop"],
      correctIndex: 0,
      explanation: "A series circuit has only one path, so the current (flow) must be the same everywhere.",
      reference: "Series Circuit Rules"
    },
    {
      id: "ser-203",
      difficulty: 4,
      pointValue: 600,
      timeLimit: 16,
      question: "Three resistors are in series: 10 ohms, 20 ohms, and 30 ohms. What is the total resistance?",
      answers: ["30 Ohms", "5.45 Ohms", "60 Ohms", "6000 Ohms"],
      correctIndex: 2,
      explanation: "Rt = R1 + R2 + R3. 10 + 20 + 30 = 60 Ohms.",
      reference: "Series Circuit Calculation"
    },
    {
      id: "ser-204",
      difficulty: 4,
      pointValue: 800,
      timeLimit: 18,
      question: "This law states that the sum of all voltage drops in a series loop equals the source voltage.",
      answers: ["Ohm's Law", "Kirchhoff's Current Law (KCL)", "Watt's Law", "Kirchhoff's Voltage Law (KVL)"],
      correctIndex: 3,
      explanation: "Kirchhoff's Voltage Law (KVL) describes how voltage is distributed in a closed loop.",
      reference: "Kirchhoff's Voltage Law"
    },
    {
      id: "ser-205",
      difficulty: 5,
      pointValue: 1000,
      timeLimit: 20,
      question: "If one of three bulbs connected in series burns out (fails open), what happens to the other two?",
      answers: ["They get brighter", "They get dimmer", "They both go out", "They are unaffected"],
      correctIndex: 2,
      explanation: "A burned-out bulb creates an open circuit, breaking the only path for current and stopping all flow.",
      reference: "Series Circuit Troubleshooting"
    }
  ],

  "Parallel Circuits": [
    {
      id: "par-201",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "What is the rule for voltage in a parallel circuit?",
      answers: ["It is the same across all branches", "It divides equally among all branches", "It is zero across all branches", "It is highest at the first branch"],
      correctIndex: 0,
      explanation: "Components in parallel are connected across the same two points, so they must have the same voltage.",
      reference: "Parallel Circuit Rules"
    },
    {
      id: "par-202",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 14,
      question: "This law states that the total current entering a junction must equal the total current leaving it.",
      answers: ["Ohm's Law", "Kirchhoff's Current Law (KCL)", "Watt's Law", "Kirchhoff's Voltage Law (KVL)"],
      correctIndex: 1,
      explanation: "Kirchhoff's Current Law (KCL) describes how current splits in parallel branches.",
      reference: "Kirchhoff's Current Law"
    },
    {
      id: "par-203",
      difficulty: 4,
      pointValue: 600,
      timeLimit: 16,
      question: "Two 10-ohm resistors are in parallel. What is their total resistance?",
      answers: ["20 Ohms", "10 Ohms", "5 Ohms", "0 Ohms"],
      correctIndex: 2,
      explanation: "Using (R1*R2)/(R1+R2): (10*10)/(10+10) = 100/20 = 5 Ohms. Total R is always less than the smallest branch.",
      reference: "Parallel Circuit Calculation"
    },
    {
      id: "par-204",
      difficulty: 4,
      pointValue: 800,
      timeLimit: 18,
      question: "In a parallel circuit, total current (It) is calculated by:",
      answers: ["Using the smallest branch current", "Averaging all branch currents", "Adding all individual branch currents", "It = I1 x I2 x I3..."],
      correctIndex: 2,
      explanation: "Total current is the sum of the currents in each branch: It = I1 + I2 + I3 + ...",
      reference: "Parallel Circuit Rules"
    },
    {
      id: "par-205",
      difficulty: 5,
      pointValue: 1000,
      timeLimit: 20,
      question: "If one of three bulbs connected in parallel burns out (fails open), what happens to the other two?",
      answers: ["They get brighter", "They get dimmer", "They both go out", "They are unaffected"],
      correctIndex: 3,
      explanation: "Each parallel branch is independent. An open in one branch does not affect the others.",
      reference: "Parallel Circuit Troubleshooting"
    }
  ],

  "Multimeter & Troubleshooting": [
    {
      id: "mtr-201",
      difficulty: 2,
      pointValue: 200,
      timeLimit: 12,
      question: "To measure voltage (VDC), a multimeter must be connected:",
      answers: ["In series with the circuit", "In parallel (across) the component", "With the circuit power OFF", "In the AMPS jack"],
      correctIndex: 1,
      explanation: "Voltage is a measurement of potential difference, so the meter must be placed in parallel (across) the points.",
      reference: "Multimeter Usage"
    },
    {
      id: "mtr-202",
      difficulty: 3,
      pointValue: 400,
      timeLimit: 14,
      question: "To measure current (AMPS), a multimeter must be connected:",
      answers: ["In series (in-line) with the circuit", "In parallel (across) the component", "With the circuit power OFF", "In the VOLTS jack"],
      correctIndex: 0,
      explanation: "Current is a measure of flow, so the circuit must be opened and the meter placed in series (in-line).",
      reference: "Multimeter Usage"
    },
    {
      id: "mtr-203",
      difficulty: 4,
      pointValue: 600,
      timeLimit: 16,
      question: "What is the most critical safety step before measuring resistance (Ohms)?",
      answers: ["Set the meter to the highest range", "Verify the meter's battery is good", "Ensure all circuit power is OFF", "Use alligator clips for safety"],
      correctIndex: 2,
      explanation: "An ohmmeter sends its own voltage. Measuring a powered circuit will, at minimum, destroy the meter.",
      reference: "Multimeter Safety"
    },
    {
      id: "mtr-204",
      difficulty: 4,
      pointValue: 800,
      timeLimit: 18,
      question: "A technician reads 'OL' or 'Infinity' on their ohmmeter when checking a wire. This indicates:",
      answers: ["A 'short circuit' to ground", "A good, low-resistance wire", "An 'open circuit' or break", "The wire has high current"],
      correctIndex: 2,
      explanation: "'OL' (Over Limit) means the resistance is too high to measure, indicating a break (an open circuit).",
      reference: "Troubleshooting Opens"
    },
    {
      id: "mtr-205",
      difficulty: 5,
      pointValue: 1000,
      timeLimit: 20,
      question: "A technician reads 0.2 Ohms when measuring from a wire to the aircraft airframe. This indicates:",
      answers: ["A 'short circuit' to ground", "A good, isolated wire", "An 'open circuit' in the wire", "The wire's normal resistance"],
      correctIndex: 0,
      explanation: "A very low resistance path from a wire to ground (airframe) is the definition of a short circuit.",
      reference: "Troubleshooting Shorts"
    }
  ],

  // ==================== FINAL JEOPARDY ====================

  FINAL: {
    cat: "Applied Circuit Troubleshooting",
    difficulty: 5,
    timeLimit: 30,
    question: "A component does not work. A technician measures 28V at the component's positive terminal and 26V at its ground terminal (relative to airframe). The circuit breaker is NOT tripped. What is the most likely fault?",
    answers: [
      "A short circuit in the power wire",
      "A high-resistance (open) ground connection",
      "A failed (open) component",
      "A shorted (failed) component"
    ],
    correctIndex: 1,
    explanation: "A good ground should read near 0V. Reading 26V on the ground wire means the ground path is open or has high resistance, and the voltage is 'floating' up to the supply voltage.",
    reference: "Troubleshooting Ground Faults"
  }
};


/* ========================================================================
   END OF CUSTOMIZABLE QUESTION BANK SECTION
   ======================================================================== */

/* Game State */
const GameState = {
  TILE_SELECTION: 'TILE_SELECTION',
  QUESTION_READING: 'QUESTION_READING',
  BUZZER_ACTIVE: 'BUZZER_ACTIVE',
  ANSWERING: 'ANSWERING',
  SHOWING_RESULT: 'SHOWING_RESULT',
  DAILY_DOUBLE: 'DAILY_DOUBLE',
  ROUND_TRANSITION: 'ROUND_TRANSITION',
  FINAL_JEOPARDY: 'FINAL_JEOPARDY',
  GAME_OVER: 'GAME_OVER'
};

let gameState = GameState.TILE_SELECTION;
let currentRound = 1; // 1 = Jeopardy, 2 = Double Jeopardy
let tiles = {};
let playerScore = 0, aiScore = 0;
let currentTurn = 'player';
let currentQ = null;
let buzzWinner = null;
let dailyDoubleIds = [];
let questionsLeft = 15;
let aiBuzzTimeout = null;

/* AI Settings */
const AI_DIFFICULTY = {
  easy: { reactionMin: 2000, reactionMax: 3500, accuracy: 0.55, name: 'Easy' },
  medium: { reactionMin: 1500, reactionMax: 2500, accuracy: 0.70, name: 'Medium' },
  hard: { reactionMin: 1000, reactionMax: 2000, accuracy: 0.80, name: 'Hard' },
  expert: { reactionMin: 800, reactionMax: 1500, accuracy: 0.88, name: 'Expert' }
};
let currentDifficulty = 'medium';

/* Timer */
let TMAX = 10, t = TMAX, tInt = null, soundOn = true;
/* Track current Daily Double wager so timeouts score correctly */
let currentDDWager = 0;

/* DOM */
const $ = s => document.querySelector(s);
const catRow = $('#catRow'), qLeft = $('#qLeft');
const pScore = $('#pScore'), aiScoreEl = $('#aiScore');
const playerBox = $('#playerBox'), aiBox = $('#aiBox');
const playerTurn = $('#playerTurn'), aiTurn = $('#aiTurn');
const rows = [$('#valRow1'), $('#valRow2'), $('#valRow3'), $('#valRow4'), $('#valRow5')];
const qCard = $('#qCard'), qCat = $('#qCat'), qValue = $('#qValue'), qText = $('#qText');
const choices = $('#choices'), feedback = $('#feedback'), closeQ = $('#closeQ');
const buzzSection = $('#buzzSection'), playerBuzz = $('#playerBuzz'), aiBuzz = $('#aiBuzz');
const qTimer = $('#qTimer'), tFill = $('#tFill'), tLeft = $('#tLeft');
const ddBadge = $('#ddBadge'), ddModal = $('#ddModal');
const confetti = $('#confetti');
const muteBtn = $('#mute'), difficultyBtn = $('#difficultyBtn');
const fjModal = $('#fjModal'), fjCat = $('#fjCat'), fjStart = $('#fjStart');
const fjPScore = $('#fjPScore'), fjAIScore = $('#fjAIScore'), fjPWager = $('#fjPWager'), fjAIWager = $('#fjAIWager');
const finalCard = $('#finalCard'), finalCat = $('#finalCat'), finalText = $('#finalText');
const finalChoices = $('#finalChoices'), finalFeedback = $('#finalFeedback'), closeFinal = $('#closeFinal');
const gameEndModal = $('#gameEndModal'), endGameTitle = $('#endGameTitle');
const endPlayerScore = $('#endPlayerScore'), endAIScore = $('#endAIScore'), endGameMessage = $('#endGameMessage');
const finalRestartBtn = $('#finalRestartBtn');
const roundIndicator = $('#roundIndicator');
const roundTransition = $('#roundTransition'), transitionTitle = $('#transitionTitle'), transitionSubtitle = $('#transitionSubtitle');

/* Audio */
let AC = null;
function ensureAudio() { if (!AC) { AC = new (window.AudioContext || window.webkitAudioContext)(); } if (AC.state === 'suspended') { AC.resume(); } }
function play(freq = 880, ms = 180, type = 'sine', gain = 0.06) {
  if (!soundOn) return;
  ensureAudio();
  const o = AC.createOscillator(), g = AC.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain; g.gain.setValueAtTime(gain, AC.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + ms / 1000);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + ms / 1000);
}
function chordOK() { play(987, 140, 'sine', 0.08); setTimeout(() => play(1479, 160, 'sine', 0.07), 110); }
function buzzer() {
  if (!soundOn) return; ensureAudio();
  const o = AC.createOscillator(), g = AC.createGain(); o.type = 'square';
  o.frequency.setValueAtTime(120, AC.currentTime); o.frequency.exponentialRampToValueAtTime(70, AC.currentTime + 0.35);
  g.gain.value = 0.08; g.gain.setValueAtTime(0.08, AC.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime + 0.4);
  o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime + 0.42);
}
function selectBlip() { play(660, 90, 'triangle', 0.06); }
function tick() { play(660, 45, 'sine', 0.03); }
function buzzSound() { play(800, 200, 'square', 0.1); }

function celebrate() {
  const colors = ["#22c55e", "#3b82f6", "#eab308", "#a855f7", "#f43f5e"];
  for (let i = 0; i < 26; i++) {
    const p = document.createElement('i');
    p.style.left = Math.random() * 100 + '%';
    p.style.top = '-10px';
    p.style.background = colors[Math.floor(Math.random() * colors.length)];
    p.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
    p.style.animationDelay = (Math.random() * 0.2) + 's';
    confetti.appendChild(p);
    setTimeout(() => p.remove(), 1700);
  }
}

function updateTurnIndicator() {
  playerBox.classList.toggle('active', currentTurn === 'player');
  aiBox.classList.toggle('active', currentTurn === 'ai');
  
  if (gameState === GameState.TILE_SELECTION) {
    playerTurn.textContent = currentTurn === 'player' ? 'üëâ Your Turn to Select' : '';
    aiTurn.textContent = currentTurn === 'ai' ? 'üëâ AI is Selecting...' : '';
  } else {
    playerTurn.textContent = '';
    aiTurn.textContent = '';
  }
}

/* Validate the structure up front so bad data fails fast */
function validateBank() {
  const cats = Object.keys(QUESTION_BANK).filter(k => k !== 'FINAL');
  if (cats.length !== 6) throw new Error(`QUESTION_BANK must have exactly 6 categories (+ FINAL). Found ${cats.length}.`);
  cats.forEach(c => {
    const arr = QUESTION_BANK[c];
    if (!Array.isArray(arr) || arr.length !== 5) {
      throw new Error(`Category "${c}" must contain exactly 5 items (has ${Array.isArray(arr) ? arr.length : 'invalid'}).`);
    }
    arr.forEach((q, i) => {
      if (!Array.isArray(q.answers) || q.answers.length !== 4) {
        throw new Error(`"${c}" item ${i+1} must have exactly 4 answers.`);
      }
      if (q.correctIndex < 0 || q.correctIndex > 3) {
        throw new Error(`"${c}" item ${i+1} has invalid correctIndex (expected 0‚Äì3).`);
      }
    });
  });
}

function init() {
  validateBank();

  const allCategoryNames = Object.keys(QUESTION_BANK).filter(k => k !== "FINAL");
  // Get first 3 categories for Round 1
  const round1Categories = allCategoryNames.slice(0, 3);
  
  playerScore = 0;
  aiScore = 0;
  currentRound = 1;
  currentTurn = 'player';
  gameState = GameState.TILE_SELECTION;
  currentQ = null;
  buzzWinner = null;
  aiBuzzTimeout = null;
  dailyDoubleIds = [];
  currentDDWager = 0;

  pScore.textContent = '$' + playerScore;
  aiScoreEl.textContent = '$' + aiScore;
  roundIndicator.textContent = 'ROUND 1: JEOPARDY';

  qCard.classList.remove('show');
  finalCard.classList.remove('show');
  gameEndModal.classList.remove('show');
  ddModal.classList.remove('show');
  fjModal.classList.remove('show');
  roundTransition.classList.remove('show');

  loadRound(round1Categories, 1);
}

function loadRound(categories, roundNum) {
  currentRound = roundNum;
  const baseValues = roundNum === 1 ? [100, 200, 300, 400, 500] : [200, 400, 600, 800, 1000];
  
  tiles = {};
  const allRoundQuestions = [];

  categories.forEach(catName => {
    const pool = QUESTION_BANK[catName] || [];

    // Guard: ensure exactly 5 per category
    if (pool.length !== 5) {
      throw new Error(`Category "${catName}" must have exactly 5 questions (has ${pool.length}).`);
    }

    pool.forEach((q, idx) => {
      const id = `${catName}-${baseValues[idx]}`;
      tiles[id] = { 
        ...q,
        id,
        category: catName,      // store the real category
        used: false,
        pointValue: baseValues[idx]
      };
      allRoundQuestions.push(tiles[id]);
    });
  });

  questionsLeft = categories.length * baseValues.length;
  qLeft.textContent = questionsLeft;

  catRow.innerHTML = '';
  categories.forEach(c => {
    const el = document.createElement('div');
    el.className = 'cat';
    el.textContent = c;
    catRow.appendChild(el);
  });

  rows.forEach((r, i) => {
    r.innerHTML = '';
    const v = baseValues[i];
    categories.forEach(catName => {
      const id = `${catName}-${v}`;
      const t = document.createElement('button');
      t.className = 'tile';
      t.textContent = `$${v}`;
      t.dataset.id = id;

      if (tiles[id]) {
        t.addEventListener('click', () => {
          if (gameState === GameState.TILE_SELECTION && currentTurn === 'player' && !tiles[id].used) {
            openTile(id, t);
          }
        });
      }
      r.appendChild(t);
    });
  });

  // Select Daily Doubles for this round
  const candidates = allRoundQuestions.filter(q => q.difficulty >= 3 && q.pointValue >= (roundNum === 1 ? 300 : 600));
  const numDailyDoubles = roundNum === 1 ? 1 : 2;
  dailyDoubleIds = [];
  
  for (let i = 0; i < numDailyDoubles && candidates.length > 0; i++) {
    const idx = Math.floor(Math.random() * candidates.length);
    dailyDoubleIds.push(candidates[idx].id);
    candidates.splice(idx, 1);
  }

  updateTurnIndicator();
}

function openTile(id, btn) {
  const data = tiles[id];
  if (!data || data.used) return;
  
  data.used = true;
  btn.classList.add('used');
  btn.innerHTML = '‚Äî';
  selectBlip();
  
  const isDailyDouble = dailyDoubleIds.includes(id);
  
  if (isDailyDouble) {
    showDailyDouble(data);
  } else {
    showQuestion(data);
  }
}

function aiSelectTile() {
  const availableTiles = Object.values(tiles).filter(t => !t.used);
  if (availableTiles.length === 0) {
    if (currentRound === 1) {
      startRound2();
    } else {
      openFinalJeopardy();
    }
    return;
  }

  gameState = GameState.TILE_SELECTION;
  updateTurnIndicator();

  availableTiles.forEach(t => {
    const btn = document.querySelector(`[data-id="${t.id}"]`);
    if (btn) btn.classList.add('ai-thinking');
  });

  setTimeout(() => {
    let selected;
    if (aiScore < playerScore - 300) {
      const highValue = availableTiles.filter(t => t.pointValue >= (currentRound === 1 ? 400 : 800));
      selected = highValue.length > 0 ? highValue[Math.floor(Math.random() * highValue.length)] : availableTiles[0];
    } else {
      selected = availableTiles[Math.floor(Math.random() * availableTiles.length)];
    }

    availableTiles.forEach(t => {
      const btn = document.querySelector(`[data-id="${t.id}"]`);
      if (btn) btn.classList.remove('ai-thinking');
    });

    const btn = document.querySelector(`[data-id="${selected.id}"]`);
    openTile(selected.id, btn);
  }, 1000 + Math.random() * 1000);
}

function startRound2() {
  gameState = GameState.ROUND_TRANSITION;
  
  // Determine who starts Round 2 (lower score)
  if (playerScore < aiScore) {
    currentTurn = 'player';
  } else if (aiScore < playerScore) {
    currentTurn = 'ai';
  } else {
    currentTurn = 'player';
  }
  
  transitionTitle.textContent = 'DOUBLE JEOPARDY';
  transitionSubtitle.textContent = 'All values are doubled! ' + (currentTurn === 'player' ? 'You start this round!' : 'AI starts this round!');
  roundTransition.classList.add('show');
  
  setTimeout(() => {
    roundTransition.classList.remove('show');
    roundIndicator.textContent = 'ROUND 2: DOUBLE JEOPARDY';
    
    // Load Round 2 categories (second set of 3)
    const allCategoryNames = Object.keys(QUESTION_BANK).filter(k => k !== "FINAL");
    const round2Categories = allCategoryNames.slice(3, 6);
    
    loadRound(round2Categories, 2);
    
    gameState = GameState.TILE_SELECTION;
    updateTurnIndicator();
    
    if (currentTurn === 'ai') {
      setTimeout(() => aiSelectTile(), 1000);
    }
  }, 3000);
}

function showDailyDouble(data) {
  currentQ = data;
  const isDDOwner = currentTurn;
  
  ddModal.classList.add('show');
  $('#ddWho').innerHTML = isDDOwner === 'player' 
    ? '<div style="color:var(--player);font-weight:700">You found the Daily Double!</div>'
    : '<div style="color:var(--ai);font-weight:700">AI found the Daily Double!</div>';
  
  const score = isDDOwner === 'player' ? playerScore : aiScore;
  $('#ddScoreDisplay').innerHTML = `Current Score: <b class="kpi">$${score}</b>`;
  
  if (isDDOwner === 'player') {
    const maxWager = Math.max(currentRound === 1 ? 1000 : 2000, score);
    $('#ddWagerSection').innerHTML = `
      <div>Wager an amount (min $100, max $${maxWager}):</div>
      <div class="input"><span>$</span><input id="ddWagerInput" type="number" min="100" max="${maxWager}" value="${Math.min(maxWager, currentRound === 1 ? 500 : 1000)}" step="50"></div>
    `;
    $('#ddButtons').innerHTML = '<button id="ddStartBtn" class="btn">Answer Question</button>';
    $('#ddStartBtn').addEventListener('click', () => {
      const wager = Math.max(100, Math.min(maxWager, Number($('#ddWagerInput').value) || 100));
      ddModal.classList.remove('show');
      showQuestion(data, true, wager);
    });
  } else {
    const maxWager = Math.max(currentRound === 1 ? 1000 : 2000, score);
    const aiWager = Math.floor(maxWager * (0.3 + Math.random() * 0.5));
    $('#ddWagerSection').innerHTML = `<div>AI is considering their wager...</div>`;
    $('#ddButtons').innerHTML = '';
    
    setTimeout(() => {
      $('#ddWagerSection').innerHTML = `<div>AI wagers: <b class="kpi">$${aiWager}</b></div>`;
      setTimeout(() => {
        ddModal.classList.remove('show');
        showQuestion(data, true, aiWager);
      }, 1500);
    }, 2000);
  }
}

function showQuestion(data, isDailyDouble = false, ddWager = 0) {
  currentQ = data;
  gameState = GameState.QUESTION_READING;
  buzzWinner = null;
  currentDDWager = isDailyDouble ? ddWager : 0; // remember DD wager
  
  qCard.classList.add('show');
  
  // Use stored category instead of parsing the id
  const catName = data.category;
  qCat.textContent = catName;
  qValue.textContent = '$' + data.pointValue;
  qText.textContent = data.question;
  choices.innerHTML = '';
  feedback.innerHTML = '';
  closeQ.classList.add('hidden');
  buzzSection.classList.add('hidden');
  ddBadge.style.display = isDailyDouble ? 'inline-block' : 'none';
  
  if (isDailyDouble) {
    qTimer.style.visibility = 'visible';
    startAnswerTimer(data.timeLimit || 15);
    
    setTimeout(() => {
      gameState = GameState.ANSWERING;
      showAnswerChoices(isDailyDouble, ddWager);
    }, 2000);
  } else {
    qTimer.style.visibility = 'hidden';
    
    setTimeout(() => {
      gameState = GameState.BUZZER_ACTIVE;
      showBuzzerSection();
    }, 3000);
  }
}

function showBuzzerSection() {
  buzzSection.classList.remove('hidden');
  playerBuzz.disabled = false;
  playerBuzz.classList.remove('winner');
  aiBuzz.classList.remove('winner');
  buzzSound();
  
  const aiSettings = AI_DIFFICULTY[currentDifficulty];
  const aiReactionTime = aiSettings.reactionMin + Math.random() * (aiSettings.reactionMax - aiSettings.reactionMin);
  
  let playerBuzzed = false;
  
  playerBuzz.onclick = () => {
    if (gameState !== GameState.BUZZER_ACTIVE || playerBuzzed) return;
    playerBuzzed = true;
    buzzWinner = 'player';
    if (aiBuzzTimeout) clearTimeout(aiBuzzTimeout);
    handleBuzzWin();
  };
  
  aiBuzzTimeout = setTimeout(() => {
    if (gameState === GameState.BUZZER_ACTIVE && !playerBuzzed) {
      buzzWinner = 'ai';
      handleBuzzWin();
    }
  }, aiReactionTime);
}

function handleBuzzWin() {
  gameState = GameState.ANSWERING;
  playerBuzz.disabled = true;
  buzzSound();
  
  if (buzzWinner === 'player') {
    playerBuzz.classList.add('winner');
  } else {
    aiBuzz.classList.add('winner');
  }
  
  setTimeout(() => {
    buzzSection.classList.add('hidden');
    qTimer.style.visibility = 'visible';
    startAnswerTimer(currentQ.timeLimit || 10);
    showAnswerChoices(false, 0);
  }, 1000);
}

function showAnswerChoices(isDailyDouble, ddWager) {
  choices.innerHTML = '';
  
  currentQ.answers.forEach((t, idx) => {
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = '<strong>' + String.fromCharCode(65 + idx) + '.</strong> ' + t;
    b.dataset.idx = idx;
    
    if (isDailyDouble) {
      if (currentTurn === 'player') {
        b.addEventListener('click', () => handleAnswer(idx, true, ddWager));
      } else {
        b.disabled = true;
      }
    } else {
      if (buzzWinner === 'player') {
        b.addEventListener('click', () => handleAnswer(idx, false, 0));
      } else {
        b.disabled = true;
      }
    }
    
    choices.appendChild(b);
  });
  
  if ((isDailyDouble && currentTurn === 'ai') || (!isDailyDouble && buzzWinner === 'ai')) {
    const aiSettings = AI_DIFFICULTY[currentDifficulty];
    const thinkTime = 1000 + Math.random() * 2000;
    
    setTimeout(() => {
      const correctAnswer = currentQ.correctIndex;
      let aiAnswer;
      
      if (Math.random() < aiSettings.accuracy) {
        aiAnswer = correctAnswer;
      } else {
        const wrongAnswers = [0, 1, 2, 3].filter(i => i !== correctAnswer);
        aiAnswer = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
      }
      
      handleAnswer(aiAnswer, isDailyDouble, ddWager);
    }, thinkTime);
  }
}

function handleAnswer(answerIdx, isDailyDouble, ddWager) {
  stopTimer();
  gameState = GameState.SHOWING_RESULT;
  
  [...choices.children].forEach(b => b.disabled = true);
  
  const correct = currentQ.correctIndex;
  const isCorrect = (answerIdx === correct);
  const answerer = isDailyDouble ? currentTurn : buzzWinner;
  const value = isDailyDouble ? ddWager : currentQ.pointValue;
  
  if (isCorrect) {
    choices.children[correct].classList.add('correct');
    if (answerer === 'player') {
      playerScore += value;
      pScore.textContent = '$' + playerScore;
    } else {
      aiScore += value;
      aiScoreEl.textContent = '$' + aiScore;
    }
    chordOK();
    celebrate();
    currentTurn = answerer;
  } else {
    if (answerIdx >= 0 && choices.children[answerIdx]) choices.children[answerIdx].classList.add('wrong');
    choices.children[correct].classList.add('correct');
    if (answerer === 'player') {
      playerScore -= value;
      pScore.textContent = '$' + playerScore;
    } else {
      aiScore -= value;
      aiScoreEl.textContent = '$' + aiScore;
    }
    buzzer();
    
    if (!isDailyDouble) {
      currentTurn = answerer === 'player' ? 'ai' : 'player';
    }
  }
  
  showExplanation(currentQ, isCorrect, answerer);
  closeQ.classList.remove('hidden');
}

function showExplanation(question, wasCorrect, answerer) {
  const answererName = answerer === 'player' ? 'You' : 'AI';
  const resultText = wasCorrect ? `‚úì ${answererName} answered correctly!` : `‚úó ${answererName} answered incorrectly`;
  
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'explanation';
  explanationDiv.innerHTML = `
    <h4>${resultText}</h4>
    <p><strong>Explanation:</strong> ${question.explanation}</p>
    ${question.reference ? `<p><small>üìö Reference: ${question.reference}</small></p>` : ''}
  `;
  feedback.appendChild(explanationDiv);
}

closeQ.addEventListener('click', () => {
  qCard.classList.remove('show');
  closeQ.classList.add('hidden');
  checkEndOrNext();
});

function checkEndOrNext() {
  questionsLeft = Object.values(tiles).filter(t => !t.used).length;
  qLeft.textContent = questionsLeft;
  
  if (questionsLeft === 0) {
    if (currentRound === 1) {
      startRound2();
    } else {
      openFinalJeopardy();
    }
  } else {
    gameState = GameState.TILE_SELECTION;
    updateTurnIndicator();
    
    if (currentTurn === 'ai') {
      aiSelectTile();
    }
  }
}

function openFinalJeopardy() {
  gameState = GameState.FINAL_JEOPARDY;
  fjCat.textContent = QUESTION_BANK.FINAL.cat;
  fjPScore.textContent = '$' + playerScore;
  fjAIScore.textContent = '$' + aiScore;
  fjPWager.max = Math.max(0, playerScore);
  fjPWager.value = Math.max(0, Math.min(playerScore, Math.floor(playerScore / 2)));
  fjAIWager.textContent = '$???';
  fjModal.classList.add('show');
}

fjStart.addEventListener('click', () => {
  const playerWager = Math.max(0, Math.min(playerScore, Number(fjPWager.value) || 0));
  
  let aiWager;
  if (aiScore > playerScore) {
    aiWager = Math.max(0, Math.min(aiScore, playerScore * 2 - aiScore + 100));
  } else {
    aiWager = Math.max(0, aiScore);
  }
  aiWager = Math.max(0, Math.min(aiScore, aiWager));
  
  fjModal.classList.remove('show');
  renderFinalQuestion(playerWager, aiWager);
});

function renderFinalQuestion(playerWager, aiWager) {
  finalCard.classList.add('show');
  finalCat.textContent = QUESTION_BANK.FINAL.cat;
  finalText.textContent = QUESTION_BANK.FINAL.question;
  finalChoices.innerHTML = '';
  finalFeedback.innerHTML = '';
  closeFinal.classList.add('hidden');
  
  QUESTION_BANK.FINAL.answers.forEach((t, idx) => {
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = `<strong>${String.fromCharCode(65 + idx)}.</strong> ${t}`;
    b.addEventListener('click', () => {
      handleFinalAnswer(idx, playerWager, aiWager);
    });
    finalChoices.appendChild(b);
  });
}

function handleFinalAnswer(playerAnswerIdx, playerWager, aiWager) {
  [...finalChoices.children].forEach(b => b.disabled = true);
  
  const correct = QUESTION_BANK.FINAL.correctIndex;
  const playerCorrect = (playerAnswerIdx === correct);
  
  const aiSettings = AI_DIFFICULTY[currentDifficulty];
  const aiCorrect = Math.random() < (aiSettings.accuracy * 0.85);
  
  finalChoices.children[playerAnswerIdx].classList.add(playerCorrect ? 'correct' : 'wrong');
  if (!playerCorrect) {
    finalChoices.children[correct].classList.add('correct');
  }
  
  if (playerCorrect) {
    playerScore += playerWager;
  } else {
    playerScore -= playerWager;
  }
  
  if (aiCorrect) {
    aiScore += aiWager;
  } else {
    aiScore -= aiWager;
  }
  
  pScore.textContent = '$' + playerScore;
  aiScoreEl.textContent = '$' + aiScore;
  
  const expDiv = document.createElement('div');
  expDiv.className = 'explanation';
  expDiv.innerHTML = `
    <h4>Final Jeopardy Results</h4>
    <p><strong>Your answer:</strong> ${playerCorrect ? '‚úì Correct!' : '‚úó Incorrect'} (Wagered $${playerWager})</p>
    <p><strong>AI answer:</strong> ${aiCorrect ? '‚úì Correct!' : '‚úó Incorrect'} (Wagered $${aiWager})</p>
    <p><strong>Explanation:</strong> ${QUESTION_BANK.FINAL.explanation}</p>
    ${QUESTION_BANK.FINAL.reference ? `<p><small>üìö Reference: ${QUESTION_BANK.FINAL.reference}</small></p>` : ''}
  `;
  finalFeedback.appendChild(expDiv);
  
  if (playerCorrect) chordOK();
  else buzzer();
  
  closeFinal.classList.remove('hidden');
}

closeFinal.addEventListener('click', () => {
  finalCard.classList.remove('show');
  endGame();
});

function endGame() {
  gameState = GameState.GAME_OVER;
  gameEndModal.classList.add('show');
  
  endPlayerScore.textContent = '$' + playerScore;
  endAIScore.textContent = '$' + aiScore;
  
  if (playerScore > aiScore) {
    endGameTitle.textContent = 'üèÜ YOU WIN!';
    endGameMessage.textContent = `Congratulations! You defeated the AI ${AI_DIFFICULTY[currentDifficulty].name} opponent by $${playerScore - aiScore}. Excellent knowledge!`;
    celebrate();
  } else if (aiScore > playerScore) {
    endGameTitle.textContent = 'ü§ñ AI WINS!';
    endGameMessage.textContent = `The AI ${AI_DIFFICULTY[currentDifficulty].name} opponent won by $${aiScore - playerScore}. Review the explanations and try again!`;
  } else {
    endGameTitle.textContent = 'ü§ù TIE GAME!';
    endGameMessage.textContent = `You and the AI ${AI_DIFFICULTY[currentDifficulty].name} opponent tied! That's impressive.`;
  }
}

function startAnswerTimer(timeLimit) {
  stopTimer();
  TMAX = timeLimit;
  t = TMAX;
  tLeft.textContent = t;
  tFill.style.transition = 'none';
  tFill.style.width = '100%';
  void tFill.offsetWidth;
  tFill.style.transition = 'width 1s linear';
  
  tInt = setInterval(() => {
    t--;
    tLeft.textContent = t;
    const percent = (t / TMAX) * 100;
    tFill.style.width = percent + '%';
    if (t <= 5 && t > 0) tick();
    if (t <= 0) {
      stopTimer();
      const isDD = ddBadge.style.display !== 'none';
      handleAnswer(-1, isDD, isDD ? currentDDWager : 0); // use stored DD wager on timeout
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(tInt);
  tInt = null;
}

muteBtn.addEventListener('click', () => {
  soundOn = !soundOn;
  muteBtn.textContent = soundOn ? 'üîà Sound' : 'üîá Muted';
});

difficultyBtn.addEventListener('click', () => {
  const difficulties = ['easy', 'medium', 'hard', 'expert'];
  const currentIdx = difficulties.indexOf(currentDifficulty);
  currentDifficulty = difficulties[(currentIdx + 1) % difficulties.length];
  difficultyBtn.textContent = `AI: ${AI_DIFFICULTY[currentDifficulty].name}`;
});

finalRestartBtn.addEventListener('click', init);
document.addEventListener('click', () => { ensureAudio(); }, { once: true });
	
	init();
	</script>
	</body>
	</html>

              <!-- Start copying from your HTML's <body> content -->
              <!-- IMPORTANT: When game ends, call: parent.completeModule('jeopardy', SCORE) -->
              
              <div style='background:#000; color:#fff; padding:40px; text-align:center; font-family:Arial;'>
                <h1 style='color:#ffc857;'>üéØ AVIONICS JEOPARDY</h1>
                <p>Replace this content with your actual Jeopardy HTML</p>
                <p>Instructions: Copy everything INSIDE your body tags and paste it here</p>
                <p>When game ends, call: parent.completeModule('jeopardy', score)</p>
                <button onclick='parent.completeModule(&quot;jeopardy&quot;, 85)' 
                        style='background:#1a2347; border:2px solid #ffc857; color:#fff; 
                               padding:15px 30px; margin:10px; cursor:pointer; font-size:16px; 
                               border-radius:8px;'>
                  Simulate Score: 85%
                </button>
              </div>
              
              <!-- End of your HTML content -->
              <!-- ========== END OF REPLACEMENT SECTION ========== -->
            "></iframe>
          </div>
          <div class="viewer-footer">System Status: Online // Module: Jeopardy</div>
        </div>
      </div>
    </main>
  </div>

  <!-- Login Modal -->
  <div class="login-modal hidden" id="login-modal">
    <div class="login-box">
      <h2>üõ©Ô∏è WELCOME PILOT</h2>
      <p>Enter your first name to begin your avionics training journey.</p>
      <form id="login-form">
        <input type="text" class="login-input" id="name-input" 
               placeholder="Your First Name" required maxlength="30" autocomplete="off" />
        <button type="submit" class="login-submit">Begin Training</button>
      </form>
    </div>
  </div>

  <script>
    // =============================================================================
    // GAMIFICATION SYSTEM - Balanced XP and Badges
    // =============================================================================
    
    const BADGES = [
      { id: 'first_flight', name: 'üõ©Ô∏è First Flight', desc: 'Complete your first module' },
      { id: 'scholar', name: 'üìö Scholar', desc: 'Complete all 4 modules' },
      { id: 'rising_star', name: '‚≠ê Rising Star', desc: 'Score 80%+ on any quiz' },
      { id: 'sharpshooter', name: 'üéØ Sharpshooter', desc: 'Score 90%+ on any quiz' },
      { id: 'perfectionist', name: 'üíØ Perfectionist', desc: 'Score 100% on any quiz' },
      { id: 'champion', name: 'üèÜ Champion', desc: 'Reach Level 5' },
      { id: 'on_fire', name: 'üî• On Fire', desc: 'Complete 3 modules in one session' },
      { id: 'master_aviator', name: '‚úàÔ∏è Master Aviator', desc: 'Score 80%+ on all 4 modules' }
    ];

    // Game state
    let gameState = {
      userName: null,
      xp: 0,
      level: 1,
      badges: [],
      completedModules: [],
      moduleAttempts: {},
      moduleScores: {},
      sessionModules: []
    };

    // Load saved state
    function loadGameState() {
      const saved = localStorage.getItem('aeaGameState');
      if (saved) {
        gameState = { ...gameState, ...JSON.parse(saved) };
        updateDisplay();
      }
    }

    // Save state
    function saveGameState() {
      localStorage.setItem('aeaGameState', JSON.stringify(gameState));
    }

    // Calculate XP for level
    function xpForLevel(level) {
      if (level === 1) return 0;
      let total = 0;
      let needed = 50;
      for (let i = 2; i <= level; i++) {
        total += needed;
        needed = Math.round(needed * 1.25);
      }
      return total;
    }

    // Calculate current level from XP
    function calculateLevel(totalXP) {
      let level = 1;
      let xpNeeded = 50;
      let xpProgress = totalXP;
      
      while (xpProgress >= xpNeeded) {
        xpProgress -= xpNeeded;
        level++;
        xpNeeded = Math.round(xpNeeded * 1.25);
      }
      
      return { level, xpProgress, xpNeeded };
    }

    // Award XP with diminishing returns
    function awardXP(module, score) {
      const attempts = gameState.moduleAttempts[module] || 0;
      let baseXP = 0;
      
      // First-time module completion bonus
      if (attempts === 0 && !gameState.completedModules.includes(module)) {
        baseXP += 20;
      }
      
      // Score-based XP with diminishing returns
      const diminishFactors = [1.0, 0.5, 0.3, 0.1];
      const factor = diminishFactors[Math.min(attempts, 3)];
      
      if (score >= 90) {
        baseXP += Math.round(15 * factor);
      } else if (score >= 80) {
        baseXP += Math.round(10 * factor);
      } else if (score >= 70) {
        baseXP += Math.round(5 * factor);
      }
      
      if (baseXP > 0) {
        const oldLevel = gameState.level;
        gameState.xp += baseXP;
        
        // Check for level up
        const newStats = calculateLevel(gameState.xp);
        gameState.level = newStats.level;
        
        // Show XP popup
        showXPGain(baseXP);
        
        // Check for level up
        if (newStats.level > oldLevel) {
          showLevelUp(newStats.level);
          checkBadge('champion');
        }
      }
      
      return baseXP;
    }

    // Check and award badges
    function checkBadge(type) {
      if (type === 'first_module' && !gameState.badges.includes('first_flight')) {
        if (gameState.completedModules.length === 1) {
          awardBadge('first_flight');
        }
      }
      
      if (type === 'all_modules' && !gameState.badges.includes('scholar')) {
        if (gameState.completedModules.length === 4) {
          awardBadge('scholar');
        }
      }
      
      if (type === 'score') {
        const scores = Object.values(gameState.moduleScores);
        const maxScore = Math.max(...scores);
        
        if (maxScore >= 80 && !gameState.badges.includes('rising_star')) {
          awardBadge('rising_star');
        }
        if (maxScore >= 90 && !gameState.badges.includes('sharpshooter')) {
          awardBadge('sharpshooter');
        }
        if (maxScore === 100 && !gameState.badges.includes('perfectionist')) {
          awardBadge('perfectionist');
        }
        
        // Check for Master Aviator
        if (!gameState.badges.includes('master_aviator')) {
          const allModules = ['classroom', 'flashcards', 'practice', 'jeopardy'];
          const allAbove80 = allModules.every(m => (gameState.moduleScores[m] || 0) >= 80);
          if (allAbove80) {
            awardBadge('master_aviator');
          }
        }
      }
      
      if (type === 'champion' && !gameState.badges.includes('champion')) {
        if (gameState.level >= 5) {
          awardBadge('champion');
        }
      }
      
      if (type === 'on_fire' && !gameState.badges.includes('on_fire')) {
        if (gameState.sessionModules.length >= 3) {
          awardBadge('on_fire');
        }
      }
    }

    // Award badge
    function awardBadge(badgeId) {
      const badge = BADGES.find(b => b.id === badgeId);
      if (badge && !gameState.badges.includes(badgeId)) {
        gameState.badges.push(badgeId);
        showBadgeUnlock(badge);
        updateDisplay();
        saveGameState();
      }
    }

    // Show XP gain animation
    function showXPGain(amount) {
      const popup = document.createElement('div');
      popup.className = 'xp-popup';
      popup.textContent = `+${amount} XP`;
      document.body.appendChild(popup);
      setTimeout(() => popup.remove(), 1000);
    }

    // Show level up animation
    function showLevelUp(newLevel) {
      const flash = document.createElement('div');
      flash.className = 'level-flash';
      document.body.appendChild(flash);
      setTimeout(() => flash.remove(), 800);
      
      setTimeout(() => {
        alert(`üéâ LEVEL UP!\n\nYou've reached Level ${newLevel}!\nKeep up the great work!`);
      }, 400);
    }

    // Show badge unlock
    function showBadgeUnlock(badge) {
      const modal = document.createElement('div');
      modal.className = 'badge-unlock';
      modal.innerHTML = `
        <span class="badge-unlock-icon">${badge.name.split(' ')[0]}</span>
        <h3>Badge Unlocked!</h3>
        <p>${badge.name}</p>
        <p style="font-size:12px;color:var(--text-muted);">${badge.desc}</p>
        <button class="badge-unlock-close" onclick="this.parentElement.remove()">Awesome!</button>
      `;
      document.body.appendChild(modal);
      setTimeout(() => { if (modal.parentNode) modal.remove(); }, 5000);
    }

    // Complete module function (called from iframes)
    function completeModule(module, score) {
      // Track attempts
      if (!gameState.moduleAttempts[module]) {
        gameState.moduleAttempts[module] = 0;
      }
      gameState.moduleAttempts[module]++;
      
      // Track best score
      if (!gameState.moduleScores[module] || gameState.moduleScores[module] < score) {
        gameState.moduleScores[module] = score;
      }
      
      // Track completion
      if (!gameState.completedModules.includes(module)) {
        gameState.completedModules.push(module);
        gameState.sessionModules.push(module);
      }
      
      // Award XP
      const xpEarned = awardXP(module, score);
      
      // Check badges
      if (gameState.completedModules.length === 1) checkBadge('first_module');
      if (gameState.completedModules.length === 4) checkBadge('all_modules');
      checkBadge('score');
      checkBadge('on_fire');
      
      // Show result
      alert(`Module Complete!\n\nScore: ${score}%\nXP Earned: ${xpEarned}\n\n${score >= 70 ? 'PASSED ‚úì' : 'Keep studying!'}`);
      
      updateDisplay();
      saveGameState();
    }

    // Update display
    function updateDisplay() {
      const stats = calculateLevel(gameState.xp);
      
      document.getElementById('level-display').textContent = stats.level;
      document.getElementById('level-num').textContent = stats.level;
      document.getElementById('xp-display').textContent = gameState.xp;
      document.getElementById('xp-current').textContent = stats.xpProgress;
      document.getElementById('xp-needed').textContent = stats.xpNeeded;
      document.getElementById('xp-progress').style.width = 
        `${(stats.xpProgress / stats.xpNeeded) * 100}%`;
      
      // Update badges
      const badgesContainer = document.getElementById('badges-container');
      if (gameState.badges.length > 0) {
        badgesContainer.innerHTML = gameState.badges.map(badgeId => {
          const badge = BADGES.find(b => b.id === badgeId);
          return `<span class="badge" title="${badge.desc}">${badge.name}</span>`;
        }).join('');
      }
      
      // Update username
      if (gameState.userName) {
        document.getElementById('user-name-display').textContent = gameState.userName;
        document.getElementById('user-bar').style.display = 'flex';
      }
    }

    // Tab navigation
    function showTab(tabName) {
      document.getElementById('home-view').style.display = 'none';
      document.getElementById('classroom-view').classList.remove('active');
      document.getElementById('flashcards-view').classList.remove('active');
      document.getElementById('practice-view').classList.remove('active');
      document.getElementById('jeopardy-view').classList.remove('active');
      
      if (tabName === 'home') {
        document.getElementById('home-view').style.display = 'block';
      } else {
        document.getElementById(tabName + '-view').classList.add('active');
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Login system
    function showLogin() {
      if (!gameState.userName) {
        document.getElementById('login-modal').classList.remove('hidden');
        document.getElementById('name-input').focus();
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      loadGameState();
      
      // Setup login form handler
      const loginForm = document.getElementById('login-form');
      if (loginForm) {
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const name = document.getElementById('name-input').value.trim();
          if (name) {
            gameState.userName = name;
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('user-name-display').textContent = name;
            document.getElementById('user-bar').style.display = 'flex';
            updateDisplay();
            saveGameState();
          }
        });
      }
      
      // Setup reset button
      const resetBtn = document.getElementById('reset-btn');
      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          if (confirm('‚ö†Ô∏è Reset all progress?\n\nThis will delete:\n‚Ä¢ XP and level\n‚Ä¢ All badges\n‚Ä¢ Module scores\n\nThis cannot be undone!')) {
            localStorage.removeItem('aeaGameState');
            location.reload();
          }
        });
      }
      
      showLogin();
      updateDisplay();
    });
  </script>
</body>
</html>
