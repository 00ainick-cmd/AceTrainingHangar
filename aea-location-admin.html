<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AEA Location Admin Panel</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .login-box p {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .error-message {
            color: #dc3545;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            color: white;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 2em;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h2 {
            font-size: 2.5em;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 25px;
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            border-color: #667eea;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .upload-zone {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .upload-zone.dragover {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .location-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .location-table th,
        .location-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .location-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .location-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-school {
            background: #d4edda;
            color: #155724;
        }

        .badge-shop {
            background: #d1ecf1;
            color: #0c5460;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .icon-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .icon-btn:hover {
            transform: translateY(-2px);
        }

        .btn-edit {
            background: #ffc107;
            color: #333;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-view {
            background: #17a2b8;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .info-box h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #666;
        }

        .info-box li {
            margin: 5px 0;
        }

        .csv-template-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
        }

        .csv-template-btn:hover {
            background: #218838;
        }

        .json-textarea {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-row button {
            flex: 1;
        }

        .geocoding-status {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .location-table {
                font-size: 0.85em;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üîê Admin Access</h1>
            <p>Enter admin password to continue</p>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="adminPassword" placeholder="Enter password">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <div class="error-message" id="loginError"></div>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                <p style="font-size: 0.9em; color: #666;">
                    <strong>First time?</strong> Default password: <code>admin123</code><br>
                    <small>Change it in your browser console: <code>localStorage.setItem('aeaAdminPassword', 'newpassword')</code></small>
                </p>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
        <div class="header">
            <div class="header-content">
                <h1>‚öôÔ∏è AEA Location Admin Panel</h1>
                <div class="header-actions">
                    <a href="aea-location-heatmap.html" class="header-btn">View Map</a>
                    <a href="index.html" class="header-btn">Training Hub</a>
                    <button class="header-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h2 id="statTotal">0</h2>
                    <p>Total Locations</p>
                </div>
                <div class="stat-card">
                    <h2 id="statSchools">0</h2>
                    <p>Schools</p>
                </div>
                <div class="stat-card">
                    <h2 id="statShops">0</h2>
                    <p>AEA Member Shops</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('manual')">‚ûï Add Manually</button>
                <button class="tab-btn" onclick="switchTab('csv')">üìÑ CSV Upload</button>
                <button class="tab-btn" onclick="switchTab('json')">üìã JSON Import</button>
                <button class="tab-btn" onclick="switchTab('manage')">üìä Manage Locations</button>
            </div>

            <!-- Manual Entry Tab -->
            <div class="tab-content active" id="tabManual">
                <h2 class="section-title">Add Location Manually</h2>
                <form id="manualForm">
                    <div class="form-group">
                        <label>Type *</label>
                        <select id="manualType" required>
                            <option value="">Select type...</option>
                            <option value="school">School</option>
                            <option value="shop">AEA Member Shop</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="manualName" placeholder="e.g., Aviation Institute of Technology" required>
                    </div>

                    <div class="form-group">
                        <label>Address *</label>
                        <input type="text" id="manualAddress" placeholder="Full address (will auto-geocode)">
                        <div class="geocoding-status" id="geocodingStatus"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Latitude</label>
                            <input type="number" step="any" id="manualLat" placeholder="e.g., 39.8283">
                        </div>
                        <div class="form-group">
                            <label>Longitude</label>
                            <input type="number" step="any" id="manualLng" placeholder="e.g., -98.5795">
                        </div>
                    </div>

                    <div class="form-group" id="programTypeGroup" style="display: none;">
                        <label>Program Type</label>
                        <input type="text" id="manualProgramType" placeholder="e.g., A&P, Avionics, etc.">
                    </div>

                    <div class="form-group">
                        <label>Contact Person</label>
                        <input type="text" id="manualContactPerson" placeholder="e.g., John Doe">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="manualPhone" placeholder="e.g., (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="manualEmail" placeholder="e.g., contact@example.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" id="manualWebsite" placeholder="e.g., https://example.com">
                    </div>

                    <div class="button-row">
                        <button type="submit" class="btn btn-success">Add Location</button>
                        <button type="button" class="btn btn-secondary" onclick="resetManualForm()">Clear Form</button>
                    </div>
                </form>
            </div>

            <!-- CSV Upload Tab -->
            <div class="tab-content" id="tabCSV">
                <h2 class="section-title">CSV Upload</h2>

                <div class="info-box">
                    <h3>CSV Format Requirements</h3>
                    <ul>
                        <li>First row must be headers</li>
                        <li><strong>Required columns:</strong> type, name, address (or lat/lng)</li>
                        <li><strong>Type values:</strong> "school" or "shop"</li>
                        <li><strong>Optional columns:</strong> programType, contactPerson, phone, email, website, lat, lng</li>
                        <li>If lat/lng not provided, addresses will be auto-geocoded</li>
                    </ul>
                    <button class="csv-template-btn" onclick="downloadCSVTemplate()">üì• Download CSV Template</button>
                </div>

                <div class="upload-zone" id="csvUploadZone" onclick="document.getElementById('csvFileInput').click()">
                    <div class="upload-icon">üì§</div>
                    <h3>Click or Drag & Drop CSV File</h3>
                    <p>Maximum file size: 5MB</p>
                    <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload(event)">
                </div>

                <div id="csvPreview"></div>
            </div>

            <!-- JSON Import Tab -->
            <div class="tab-content" id="tabJSON">
                <h2 class="section-title">JSON Import</h2>

                <div class="info-box">
                    <h3>JSON Format</h3>
                    <p>Import an array of location objects:</p>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 10px;">
[
  {
    "type": "school",
    "name": "Aviation Institute",
    "address": "123 Main St, City, State ZIP",
    "lat": 39.8283,
    "lng": -98.5795,
    "programType": "A&P",
    "contactPerson": "John Doe",
    "phone": "(555) 123-4567",
    "email": "contact@example.com",
    "website": "https://example.com"
  }
]</pre>
                </div>

                <div class="form-group">
                    <label>Paste JSON Data</label>
                    <textarea id="jsonInput" class="json-textarea" placeholder="Paste your JSON array here..."></textarea>
                </div>

                <div class="button-row">
                    <button class="btn btn-success" onclick="importJSON()">Import JSON</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('jsonInput').value = ''">Clear</button>
                </div>
            </div>

            <!-- Manage Locations Tab -->
            <div class="tab-content" id="tabManage">
                <h2 class="section-title">Manage Locations</h2>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-success" style="width: auto;" onclick="exportToCSV()">üì• Export to CSV</button>
                    <button class="btn btn-secondary" style="width: auto;" onclick="exportToJSON()">üìã Export to JSON</button>
                    <button class="btn btn-danger" style="width: auto;" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>

                <div id="manageContent">
                    <div class="no-data-message">
                        <h3>No locations yet</h3>
                        <p>Add locations using the tabs above</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Location</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">

                <div class="form-group">
                    <label>Type *</label>
                    <select id="editType" required>
                        <option value="school">School</option>
                        <option value="shop">AEA Member Shop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="editName" required>
                </div>

                <div class="form-group">
                    <label>Address *</label>
                    <input type="text" id="editAddress">
                    <div class="geocoding-status" id="editGeocodingStatus"></div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" step="any" id="editLat">
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" step="any" id="editLng">
                    </div>
                </div>

                <div class="form-group" id="editProgramTypeGroup">
                    <label>Program Type</label>
                    <input type="text" id="editProgramType">
                </div>

                <div class="form-group">
                    <label>Contact Person</label>
                    <input type="text" id="editContactPerson">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="editPhone">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editEmail">
                    </div>
                </div>

                <div class="form-group">
                    <label>Website</label>
                    <input type="url" id="editWebsite">
                </div>

                <div class="button-row">
                    <button type="submit" class="btn btn-success">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loadingMessage">Processing...</h3>
        </div>
    </div>

    <script>
        // Initialize
        let locations = [];
        let nextId = 1;
        const DEFAULT_PASSWORD = 'admin123';

        // Load data on startup
        function loadData() {
            const stored = localStorage.getItem('aeaLocations');
            if (stored) {
                locations = JSON.parse(stored);
                nextId = Math.max(...locations.map(l => l.id), 0) + 1;
            }
            updateStats();
            updateManageView();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('aeaLocations', JSON.stringify(locations));
            updateStats();
            updateManageView();
        }

        // Login
        function login() {
            const password = document.getElementById('adminPassword').value;
            const storedPassword = localStorage.getItem('aeaAdminPassword') || DEFAULT_PASSWORD;

            if (password === storedPassword) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadData();
            } else {
                document.getElementById('loginError').textContent = 'Invalid password';
            }
        }

        // Logout
        function logout() {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').textContent = '';
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

            if (tabName === 'manage') {
                updateManageView();
            }
        }

        // Update statistics
        function updateStats() {
            const schools = locations.filter(l => l.type === 'school').length;
            const shops = locations.filter(l => l.type === 'shop').length;

            document.getElementById('statTotal').textContent = locations.length;
            document.getElementById('statSchools').textContent = schools;
            document.getElementById('statShops').textContent = shops;
        }

        // Sleep/delay function for rate limiting
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Geocoding function with rate limiting
        async function geocodeAddress(address) {
            if (!address) return null;

            try {
                // Add delay to respect Nominatim rate limits (1 request per second)
                await sleep(1000);

                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`, {
                    headers: {
                        'User-Agent': 'AEA-Location-Map/1.0'
                    }
                });

                if (!response.ok) {
                    console.error('Geocoding HTTP error:', response.status);
                    return null;
                }

                const data = await response.json();

                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }

            return null;
        }

        // Proper CSV parser that handles quoted fields
        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let insideQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];

                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        // Escaped quote
                        currentField += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    // End of field
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    // End of row
                    if (char === '\r' && nextChar === '\n') {
                        i++; // Skip \n in \r\n
                    }
                    if (currentField || currentRow.length > 0) {
                        currentRow.push(currentField.trim());
                        if (currentRow.some(field => field !== '')) {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentField = '';
                    }
                } else {
                    currentField += char;
                }
            }

            // Add last field and row
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(field => field !== '')) {
                    rows.push(currentRow);
                }
            }

            return rows;
        }

        // Show/hide program type field based on type selection
        document.getElementById('manualType').addEventListener('change', function() {
            const programTypeGroup = document.getElementById('programTypeGroup');
            if (this.value === 'school') {
                programTypeGroup.style.display = 'block';
            } else {
                programTypeGroup.style.display = 'none';
            }
        });

        // Auto-geocode when address is entered
        let geocodeTimeout;
        document.getElementById('manualAddress').addEventListener('input', function() {
            clearTimeout(geocodeTimeout);
            const status = document.getElementById('geocodingStatus');
            status.textContent = 'Typing...';

            geocodeTimeout = setTimeout(async () => {
                const address = this.value.trim();
                if (!address) {
                    status.textContent = '';
                    return;
                }

                status.textContent = 'Geocoding...';
                const coords = await geocodeAddress(address);

                if (coords) {
                    document.getElementById('manualLat').value = coords.lat;
                    document.getElementById('manualLng').value = coords.lng;
                    status.textContent = '‚úì Geocoded successfully';
                    status.style.color = '#28a745';
                } else {
                    status.textContent = '‚ö† Could not geocode. Enter coordinates manually.';
                    status.style.color = '#ffc107';
                }
            }, 1000);
        });

        // Manual form submission
        document.getElementById('manualForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const lat = parseFloat(document.getElementById('manualLat').value);
            const lng = parseFloat(document.getElementById('manualLng').value);

            if (!lat || !lng) {
                alert('Please provide valid coordinates. Try entering an address to auto-geocode.');
                return;
            }

            const location = {
                id: nextId++,
                type: document.getElementById('manualType').value,
                name: document.getElementById('manualName').value.trim(),
                address: document.getElementById('manualAddress').value.trim(),
                lat: lat,
                lng: lng,
                programType: document.getElementById('manualProgramType').value.trim(),
                contactPerson: document.getElementById('manualContactPerson').value.trim(),
                phone: document.getElementById('manualPhone').value.trim(),
                email: document.getElementById('manualEmail').value.trim(),
                website: document.getElementById('manualWebsite').value.trim()
            };

            locations.push(location);
            saveData();

            alert('Location added successfully!');
            resetManualForm();
        });

        // Reset manual form
        function resetManualForm() {
            document.getElementById('manualForm').reset();
            document.getElementById('geocodingStatus').textContent = '';
            document.getElementById('programTypeGroup').style.display = 'none';
        }

        // CSV Upload handling
        document.getElementById('csvUploadZone').addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        document.getElementById('csvUploadZone').addEventListener('dragleave', function() {
            this.classList.remove('dragover');
        });

        document.getElementById('csvUploadZone').addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processCSVFile(file);
            } else {
                alert('Please upload a CSV file');
            }
        });

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processCSVFile(file);
            }
        }

        async function processCSVFile(file) {
            showLoading('Processing CSV file...');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const text = e.target.result;

                    // Use proper CSV parser that handles quoted fields
                    const rows = parseCSV(text);

                    if (rows.length < 2) {
                        hideLoading();
                        alert('CSV file is empty or invalid. Must have at least a header row and one data row.');
                        return;
                    }

                    const headers = rows[0].map(h => h.toLowerCase().replace(/['"]/g, ''));
                    const newLocations = [];
                    const errors = [];

                    console.log('CSV Headers:', headers);

                    for (let i = 1; i < rows.length; i++) {
                        // Skip empty rows
                        if (!rows[i] || rows[i].every(cell => !cell)) continue;

                        const rowData = {};
                        headers.forEach((header, index) => {
                            if (rows[i][index] !== undefined) {
                                // Remove surrounding quotes if present
                                rowData[header] = rows[i][index].replace(/^["']|["']$/g, '');
                            }
                        });

                        console.log(`Row ${i}:`, rowData);

                        if (!rowData.name || !rowData.type) {
                            errors.push(`Row ${i + 1}: Missing required fields (name or type)`);
                            continue;
                        }

                        let lat = parseFloat(rowData.lat);
                        let lng = parseFloat(rowData.lng);

                        // Geocode if no coordinates
                        if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && rowData.address) {
                            showLoading(`Geocoding ${i}/${rows.length - 1}: ${rowData.name}...`);
                            try {
                                const coords = await geocodeAddress(rowData.address);
                                if (coords) {
                                    lat = coords.lat;
                                    lng = coords.lng;
                                    console.log(`Geocoded ${rowData.name}:`, lat, lng);
                                } else {
                                    errors.push(`Row ${i + 1}: Could not geocode address for "${rowData.name}"`);
                                }
                            } catch (geocodeError) {
                                console.error('Geocoding error:', geocodeError);
                                errors.push(`Row ${i + 1}: Geocoding failed for "${rowData.name}"`);
                            }
                        }

                        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                            newLocations.push({
                                id: nextId++,
                                type: rowData.type.toLowerCase(),
                                name: rowData.name,
                                address: rowData.address || '',
                                lat: lat,
                                lng: lng,
                                programType: rowData.programtype || rowData.programType || '',
                                contactPerson: rowData.contactperson || rowData.contactPerson || '',
                                phone: rowData.phone || '',
                                email: rowData.email || '',
                                website: rowData.website || ''
                            });
                        } else {
                            errors.push(`Row ${i + 1}: Invalid or missing coordinates for "${rowData.name}"`);
                        }
                    }

                    hideLoading();

                    // Show results
                    let message = '';
                    if (newLocations.length > 0) {
                        locations = locations.concat(newLocations);
                        saveData();
                        message = `‚úÖ Successfully imported ${newLocations.length} location(s)!`;

                        if (errors.length > 0) {
                            message += `\n\n‚ö†Ô∏è ${errors.length} row(s) had issues:\n${errors.slice(0, 5).join('\n')}`;
                            if (errors.length > 5) {
                                message += `\n... and ${errors.length - 5} more. Check console for details.`;
                            }
                        }

                        alert(message);
                        console.log('Import errors:', errors);
                        document.getElementById('csvFileInput').value = '';
                    } else {
                        message = '‚ùå No valid locations found in CSV.\n\n';
                        if (errors.length > 0) {
                            message += `Issues found:\n${errors.slice(0, 5).join('\n')}`;
                            if (errors.length > 5) {
                                message += `\n... and ${errors.length - 5} more`;
                            }
                        }
                        message += '\n\nPlease check:\n‚Ä¢ CSV has header row (type,name,address,lat,lng,...)\n‚Ä¢ Each row has valid data\n‚Ä¢ Addresses are complete or coordinates are provided';
                        alert(message);
                        console.log('All errors:', errors);
                    }
                } catch (error) {
                    hideLoading();
                    alert('Error processing CSV file: ' + error.message + '\n\nPlease check the file format and try again.');
                    console.error('CSV processing error:', error);
                }
            };

            reader.onerror = function() {
                hideLoading();
                alert('Error reading file. Please try again.');
            };

            reader.readAsText(file);
        }

        // Download CSV template
        function downloadCSVTemplate() {
            const template = 'type,name,address,lat,lng,programType,contactPerson,phone,email,website\nschool,Example Aviation School,"123 Main St, City, ST 12345",39.8283,-98.5795,A&P,John Doe,(555) 123-4567,contact@example.com,https://example.com\nshop,Example Repair Shop,"456 Oak Ave, Town, ST 67890",40.7128,-74.0060,,Jane Smith,(555) 987-6543,info@shop.com,https://shop.com';

            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'aea-locations-template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // JSON Import
        async function importJSON() {
            const jsonText = document.getElementById('jsonInput').value.trim();

            if (!jsonText) {
                alert('Please paste JSON data');
                return;
            }

            try {
                const data = JSON.parse(jsonText);

                if (!Array.isArray(data)) {
                    alert('JSON must be an array of locations.\n\nExample:\n[\n  {"type": "school", "name": "...", "address": "...", ...}\n]');
                    return;
                }

                if (data.length === 0) {
                    alert('JSON array is empty. Please provide at least one location.');
                    return;
                }

                showLoading('Importing JSON...');

                const newLocations = [];
                const errors = [];

                for (let i = 0; i < data.length; i++) {
                    const item = data[i];

                    if (!item.name || !item.type) {
                        errors.push(`Item ${i + 1}: Missing required fields (name or type)`);
                        continue;
                    }

                    let lat = parseFloat(item.lat);
                    let lng = parseFloat(item.lng);

                    // Geocode if no coordinates
                    if ((!lat || !lng || isNaN(lat) || isNaN(lng)) && item.address) {
                        showLoading(`Geocoding ${i + 1}/${data.length}: ${item.name}...`);
                        try {
                            const coords = await geocodeAddress(item.address);
                            if (coords) {
                                lat = coords.lat;
                                lng = coords.lng;
                                console.log(`Geocoded ${item.name}:`, lat, lng);
                            } else {
                                errors.push(`Item ${i + 1}: Could not geocode address for "${item.name}"`);
                            }
                        } catch (geocodeError) {
                            console.error('Geocoding error:', geocodeError);
                            errors.push(`Item ${i + 1}: Geocoding failed for "${item.name}"`);
                        }
                    }

                    if (item.name && item.type && lat && lng && !isNaN(lat) && !isNaN(lng)) {
                        newLocations.push({
                            id: nextId++,
                            type: item.type.toLowerCase(),
                            name: item.name,
                            address: item.address || '',
                            lat: lat,
                            lng: lng,
                            programType: item.programType || '',
                            contactPerson: item.contactPerson || '',
                            phone: item.phone || '',
                            email: item.email || '',
                            website: item.website || ''
                        });
                    } else {
                        errors.push(`Item ${i + 1}: Invalid or missing coordinates for "${item.name}"`);
                    }
                }

                hideLoading();

                // Show results
                let message = '';
                if (newLocations.length > 0) {
                    locations = locations.concat(newLocations);
                    saveData();
                    message = `‚úÖ Successfully imported ${newLocations.length} location(s)!`;

                    if (errors.length > 0) {
                        message += `\n\n‚ö†Ô∏è ${errors.length} item(s) had issues:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... and ${errors.length - 5} more. Check console for details.`;
                        }
                    }

                    alert(message);
                    console.log('Import errors:', errors);
                    document.getElementById('jsonInput').value = '';
                } else {
                    message = '‚ùå No valid locations found in JSON.\n\n';
                    if (errors.length > 0) {
                        message += `Issues found:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) {
                            message += `\n... and ${errors.length - 5} more`;
                        }
                    }
                    message += '\n\nPlease check:\n‚Ä¢ Each item has "type", "name", and either "address" or "lat"/"lng"\n‚Ä¢ Coordinates are valid numbers\n‚Ä¢ Type is "school" or "shop"';
                    alert(message);
                    console.log('All errors:', errors);
                }

            } catch (error) {
                hideLoading();
                alert('Invalid JSON format: ' + error.message + '\n\nPlease check your JSON syntax and try again.');
                console.error('JSON parsing error:', error);
            }
        }

        // Update manage view
        function updateManageView() {
            const container = document.getElementById('manageContent');

            if (locations.length === 0) {
                container.innerHTML = `
                    <div class="no-data-message">
                        <h3>No locations yet</h3>
                        <p>Add locations using the tabs above</p>
                    </div>
                `;
                return;
            }

            // Sort by name
            const sortedLocations = [...locations].sort((a, b) => a.name.localeCompare(b.name));

            let html = '<table class="location-table"><thead><tr>';
            html += '<th>Type</th><th>Name</th><th>Address</th><th>Contact</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            sortedLocations.forEach(loc => {
                const typeClass = loc.type === 'school' ? 'badge-school' : 'badge-shop';
                const typeLabel = loc.type === 'school' ? 'School' : 'Shop';

                html += '<tr>';
                html += `<td><span class="badge ${typeClass}">${typeLabel}</span></td>`;
                html += `<td><strong>${loc.name}</strong>${loc.programType ? `<br><small>${loc.programType}</small>` : ''}</td>`;
                html += `<td>${loc.address || 'N/A'}</td>`;
                html += `<td>${loc.contactPerson || 'N/A'}${loc.phone ? `<br>${loc.phone}` : ''}</td>`;
                html += `<td><div class="action-buttons">`;
                html += `<button class="icon-btn btn-edit" onclick="editLocation(${loc.id})">‚úèÔ∏è Edit</button>`;
                html += `<button class="icon-btn btn-delete" onclick="deleteLocation(${loc.id})">üóëÔ∏è Delete</button>`;
                html += `</div></td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Edit location
        function editLocation(id) {
            const location = locations.find(l => l.id === id);
            if (!location) return;

            document.getElementById('editId').value = location.id;
            document.getElementById('editType').value = location.type;
            document.getElementById('editName').value = location.name;
            document.getElementById('editAddress').value = location.address || '';
            document.getElementById('editLat').value = location.lat || '';
            document.getElementById('editLng').value = location.lng || '';
            document.getElementById('editProgramType').value = location.programType || '';
            document.getElementById('editContactPerson').value = location.contactPerson || '';
            document.getElementById('editPhone').value = location.phone || '';
            document.getElementById('editEmail').value = location.email || '';
            document.getElementById('editWebsite').value = location.website || '';

            // Show/hide program type field
            if (location.type === 'school') {
                document.getElementById('editProgramTypeGroup').style.display = 'block';
            } else {
                document.getElementById('editProgramTypeGroup').style.display = 'none';
            }

            document.getElementById('editModal').classList.add('active');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        // Edit form submission
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('editId').value);
            const index = locations.findIndex(l => l.id === id);

            if (index === -1) return;

            const lat = parseFloat(document.getElementById('editLat').value);
            const lng = parseFloat(document.getElementById('editLng').value);

            if (!lat || !lng) {
                alert('Please provide valid coordinates');
                return;
            }

            locations[index] = {
                id: id,
                type: document.getElementById('editType').value,
                name: document.getElementById('editName').value.trim(),
                address: document.getElementById('editAddress').value.trim(),
                lat: lat,
                lng: lng,
                programType: document.getElementById('editProgramType').value.trim(),
                contactPerson: document.getElementById('editContactPerson').value.trim(),
                phone: document.getElementById('editPhone').value.trim(),
                email: document.getElementById('editEmail').value.trim(),
                website: document.getElementById('editWebsite').value.trim()
            };

            saveData();
            closeEditModal();
            alert('Location updated successfully!');
        });

        // Delete location
        function deleteLocation(id) {
            if (!confirm('Are you sure you want to delete this location?')) return;

            locations = locations.filter(l => l.id !== id);
            saveData();
            alert('Location deleted successfully!');
        }

        // Export to CSV
        function exportToCSV() {
            if (locations.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = 'type,name,address,lat,lng,programType,contactPerson,phone,email,website\n';

            locations.forEach(loc => {
                csv += `${loc.type},${loc.name},"${loc.address}",${loc.lat},${loc.lng},${loc.programType || ''},${loc.contactPerson || ''},${loc.phone || ''},${loc.email || ''},${loc.website || ''}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aea-locations-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Export to JSON
        function exportToJSON() {
            if (locations.length === 0) {
                alert('No data to export');
                return;
            }

            const json = JSON.stringify(locations, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aea-locations-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Clear all data
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL locations permanently. Are you sure?')) return;
            if (!confirm('This action cannot be undone. Continue?')) return;

            locations = [];
            nextId = 1;
            saveData();
            alert('All data cleared successfully!');
        }

        // Loading overlay
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Enter key login
        document.getElementById('adminPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // Show/hide edit program type field
        document.getElementById('editType').addEventListener('change', function() {
            const programTypeGroup = document.getElementById('editProgramTypeGroup');
            if (this.value === 'school') {
                programTypeGroup.style.display = 'block';
            } else {
                programTypeGroup.style.display = 'none';
            }
        });

        // Auto-geocode in edit modal
        let editGeocodeTimeout;
        document.getElementById('editAddress').addEventListener('input', function() {
            clearTimeout(editGeocodeTimeout);
            const status = document.getElementById('editGeocodingStatus');
            status.textContent = 'Typing...';

            editGeocodeTimeout = setTimeout(async () => {
                const address = this.value.trim();
                if (!address) {
                    status.textContent = '';
                    return;
                }

                status.textContent = 'Geocoding...';
                const coords = await geocodeAddress(address);

                if (coords) {
                    document.getElementById('editLat').value = coords.lat;
                    document.getElementById('editLng').value = coords.lng;
                    status.textContent = '‚úì Geocoded successfully';
                    status.style.color = '#28a745';
                } else {
                    status.textContent = '‚ö† Could not geocode. Enter coordinates manually.';
                    status.style.color = '#ffc107';
                }
            }, 1000);
        });
    </script>
</body>
</html>
